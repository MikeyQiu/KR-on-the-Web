9
1
0
2
 
y
a
M
 
7
2
 
 
]

G
L
.
s
c
[
 
 
2
v
1
8
9
0
0
.
2
0
9
1
:
v
i
X
r
a

Learning Counterfactual Representations for
Estimating Individual Dose-Response Curves

Patrick Schwab1, Lorenz Linhardt2, Stefan Bauer3, Joachim M. Buhmann2, Walter Karlen1
1Institute of Robotics and Intelligent Systems, ETH Zurich, Switzerland
2 Department of Computer Science, ETH Zurich, Switzerland
3 MPI for Intelligent Systems, Tübingen, Germany
patrick.schwab@hest.ethz.ch

Abstract

Estimating what would be an individual’s potential response to varying levels of
exposure to a treatment is of high practical relevance for several important ﬁelds,
such as healthcare, economics and public policy. However, existing methods for
learning to estimate counterfactual outcomes from observational data are either
focused on estimating average dose-response curves, or limited to settings with only
two treatments that do not have an associated dosage parameter. Here, we present
a novel machine-learning approach towards learning counterfactual representations
for estimating individual dose-response curves for any number of treatments with
continuous dosage parameters with neural networks. Building on the established
potential outcomes framework, we introduce performance metrics, model selection
criteria, model architectures, and open benchmarks for estimating individual dose-
response curves. Our experiments show that the methods developed in this work
set a new state-of-the-art in estimating individual dose-response.

1

Introduction

Estimating dose-response curves from observational data is an important problem in many domains.
In medicine, for example, we would be interested in using data of people that have been treated in
the past to predict which treatments and associated dosages would lead to better outcomes for new
patients [1]. This question is, at its core, a counterfactual one, i.e. we are interested in predicting what
would have happened if we were to give a patient a speciﬁc treatment at a speciﬁc dosage in a given
situation. Answering such counterfactual questions is a challenging task that requires either further
assumptions about the underlying data-generating process or prospective interventional experiments,
such as randomised controlled trials (RCTs) [2–4]. However, performing prospective experiments
is expensive, time-consuming, and, in many cases, ethically not justiﬁable [5]. Two aspects make
estimating counterfactual outcomes from observational data alone difﬁcult [6, 7]: Firstly, we only
observe the factual outcome and never the counterfactual outcomes that would potentially have
happened had we chosen a different treatment option. In medicine, for example, we only observe the
outcome of giving a patient a speciﬁc treatment at a speciﬁc dosage, but we never observe what would
have happened if the patient was instead given a potential alternative treatment or a different dosage
of the same treatment. Secondly, treatments are typically not assigned at random in observational
data. In the medical setting, physicians take a range of factors, such as the patient’s expected response
to the treatment, into account when choosing a treatment option. Due to this treatment assignment
bias, the treated population may differ signiﬁcantly from the general population. A supervised model
naïvely trained to minimise the factual error would overﬁt to the properties of the treated group, and
therefore not generalise to the entire population.

To address these problems, we introduce a novel methodology for training neural networks for
counterfactual inference that extends to any number of treatments with continuous dosage parameters.
In order to control for the biased assignment of treatments in observational data, we combine our

arXiv Preprint.

method with a variety of regularisation schemes originally developed for the discrete treatment
setting, such as distribution matching [8, 9], propensity dropout (PD) [10], and matching on balancing
scores [7, 11, 12]. In addition, we devise performance metrics, model selection criteria and open
benchmarks for estimating individual dose-response curves. Our experiments demonstrate that the
methods developed in this work set a new state-of-the-art in inferring individual dose-response curves.
The source code for this work is available at https://github.com/d909b/drnet.

Contributions. We present the following contributions:

•

•

•

•

We introduce a novel methodology for training neural networks for counterfactual inference that,
in contrast to existing methods, is suitable for estimating counterfactual outcomes for any number
of treatment options with associated exposure parameters.
We develop performance metrics, model selection criteria, model architectures, and open bench-
marks for estimating individual dose-response curves.
We extend state-of-the-art methods for counterfactual inference for two non-parametric treatment
options to the multiple parametric treatment options setting.
We perform extensive experiments that show that our method sets a new state-of-the-art in inferring
individual dose-response curves from observational data across several challenging datasets.

2 Related Work

Background. Causal analysis of treatment effects with rigorous experiments is, in many domains,
an essential tool for validating interventions. In medicine, prospective experiments, such as RCTs,
are the de facto gold standard to evaluate whether a given treatment is efﬁcacious in treating a speciﬁc
indication across a population [13, 14]. However, performing prospective experiments is expensive,
time-consuming, and often not possible for ethical reasons [5]. Historically, there has therefore been
considerable interest in developing methodologies for performing causal inference using readily
available observational data [3, 11, 15–19]. The naïve approach of training supervised models to
minimise the observed factual error is in general not a suitable choice for counterfactual inference
tasks due to treatment assignment bias and the inability to observe counterfactual outcomes. To
address the shortcomings of unsupervised and supervised learning in this setting, several adaptations
to established machine-learning methods that aim to enable the estimation of counterfactual outcomes
from observational data have recently been proposed [6–10, 20–22]. In this work, we build on several
of these advances to develop a machine-learning approach for estimating individual dose-response
with neural networks.

1 Matching methods [12] are among the most
Estimating Individual Treatment Effects (ITE).
widely used approaches to causal inference from observational data. Matching methods estimate
the counterfactual outcome of a sample X to a treatment t using the observed factual outcome of
its nearest neighbours that have received t. Propensity score matching (PSM) [11] combats the
curse of dimensionality of matching directly on the covariates X by instead matching on the scalar
X) of receiving a treatment t given the covariates X. Another category of approaches
probability p(t
|
uses adjusted regression models that receive both the covariates X and the treatment t as inputs.
The simplest such model is Ordinary Least Squares (OLS), which may use either one model for
all treatments, or a separate model for each treatment [23]. More complex models based on neural
networks, like Treatment Agnostic Representation Networks (TARNETs), may be used to build
non-linear regression models [9]. Estimators that combine a form of adjusted regression with a model
for the exposure in a manner that makes them robust to misspeciﬁcation of either are referred to as
doubly robust [24]. In addition to OLS and neural networks, tree-based estimators, such as Bayesian
Additive Regression Trees (BART) [25, 26] and Causal Forests (CF) [20], and distribution modelling
methods, such as Causal Multi-task Gaussian Processes (CMGP) [21], Causal Effect Variational
Autoencoders (CEVAEs) [22], and Generative Adversarial Nets for inference of Individualised
Treatment Effects (GANITE) [6], have also been proposed for ITE estimation.2 Other approaches,
such as balancing neural networks (BNNs) [8] and counterfactual regression networks (CFRNET) [9],
attempt to achieve balanced covariate distributions across treatment groups by explicitly minimising

1The ITE is sometimes also referred to as the conditional average treatment effect (CATE).
2See [27] and [7] for empirical comparisons of large-numbers of machine-learning methods for ITE estimation

for two and more available treatment options.

2

the empirical discrepancy distance between treatment groups using metrics such as the Wasserstein
distance [28]. Most of the works mentioned above focus on the simplest setting with two available
treatment options without associated dosage parameters. A notable exception is the generalised
propensity score (GPS) [1] that extends the propensity score to treatments with continuous dosages.

In contrast to existing methods, we present the ﬁrst machine-learning approach to learn to estimate
individual dose-response curves for multiple available treatments with a continuous dosage parameter
from observational data with neural networks. We additionally extend several known regularisation
schemes for counterfactual inference to address the treatment assignment bias in observational data.
To facilitate future research in this important area, we introduce performance metrics, model selection
criteria, and open benchmarks. We believe this work could be particularly important for applications
in precision medicine, where the current state-of-the-art of estimating the average dose response
across the entire population does not take into account individual differences, even though large
differences in dose-response between individuals are well-documented for many diseases [29–31].

3 Methodology

∈

−

1
}

[0 . . p

0, ..., k
{

−
st ∈
applied at a dosage st ∈ {

Problem Statement. We consider a setting in which we are given N observed samples X with p
1]. For each sample, the potential outcomes yn,t(st)
pre-treatment covariates xi and i
are the response of the nth sample to a treatment t out of the set of k available treatment options
T =
, where at and bt are the
minimum and maximum dosage for treatment t, respectively. The set of treatments T can have two or
more available treatment options. As training data, we receive factual samples X and their observed
outcomes yn,f (sf ) after applying a speciﬁc observed treatment f at dosage sf . Using the training
data with factual outcomes, we wish to train a predictive model to produce accurate estimates ˆyt(n, s)
of the potential outcomes across the entire range of s for all available treatment options t. We refer
to the range of potential outcomes yn,t(s) across s as the individual dose-response curve of the nth
sample. This setting is a direct extension of the Rubin-Neyman potential outcomes framework [32].

R, at > 0

at ≤

bt}

≤

s

|

Assumptions. Following [1, 33], we assume unconfoundedness, which consists of three key parts:
(1) Conditional Independence Assumption: The assignment to treatment t is independent of the
outcome yt given the pre-treatment covariates X, (2) Common Support Assumption: For all values
of X, it must be possible to observe all treatment options with a probability greater than 0, and (3)
Stable Unit Treatment Value Assumption: The observed outcome of any one unit must be unaffected
by the assignments of treatments to other units. In addition, we assume smoothness, i.e. that units
with similar covariates xi have similar outcomes y, both for model training and selection.

Metrics. To enable a meaningful comparison of models in the presented setting, we use metrics
that cover several desirable aspects of models trained for estimating individual dose-response curves.
Our proposed metrics respectively aim to measure a predictive model’s ability (1) to recover the
dose-response curve across the entire range of dosage values, (2) to determine the optimal dosage
point for each treatment, and (3) to deduce the optimal treatment policy overall, including selection
of the right treatment and dosage point, for each individual case. To measure to what degree a model
covers the entire range of individual dose-response curves, we use the mean integrated square error3
(MISE) between the true dose-response y and the predicted dose-response ˆy as estimated by the
model over N samples, all treatments T , and the entire range [at, bt] of dosages s.

MISE =

1
N

1
T

|

|

(cid:88)

N
(cid:88)

(cid:90) bt

(cid:16)

t

T

n=1

∈

s=at

yn,t(s)

ˆyn,t(s)

ds

−

(cid:17)2

To further measure a model’s ability to determine the optimal dosage point for each individual case,
we calculate the mean dosage policy error (DPE). The mean dosage policy error is the mean squared
error in outcome y associated with using the estimated optimal dosage point ˆs∗t according to the
predictive model to determine the true optimal dosage point s∗t over N samples and all treatments T .

(1)

(2)

DPE =

1
N

1
T

|

|

(cid:88)

N
(cid:88)

(cid:16)

t

T

n=1

∈

yn,t(s∗t )

yn,t(ˆs∗t )

−

(cid:17)2

3A normalised version of this metric has been used in Silva [34].

3

(4)

(5)

(7)

where s∗t and ˆs∗t are the optimal dosage point according to the true dose-response curve and the
estimated dose-response curve, respectively.

s∗t = arg max
[at,bt]
s
∈

yn,t(s)

(3)

ˆs∗t = arg max
[at,bt]
s
∈

ˆyn,t(s)

Finally, the policy error (PE) measures a model’s ability to determine the optimal treatment policy for
individual cases, i.e. how much worse the outcome would be when using the estimated best optimal
treatment option as opposed to the true optimal treatment option and dosage.

PE =

1
N

N
(cid:88)

(cid:16)

n=1

yn,t∗ (s∗t∗ )

yn,ˆt∗ (ˆs∗ˆt∗ )

−

(cid:17)2

where

t∗ = arg max

yn,t(s∗t )

(6)

t

T

∈

ˆt∗ = arg max
t

T

∈

ˆyn,t(ˆs∗t )

are the optimal treatment option according to the ground truth y and the predictive model, respectively.
Considering the DPE and PE alongside the MISE is important to comprehensively evaluate models
for counterfactual inference. For example, a model that accurately recovers dose response curves
outside the regions containing the optimal response would achieve a respectable MISE but would not
be a good model for determining the treatment and dosage choices that lead to the best outcome for
a given unit. By considering multiple metrics, we can ensure that predictive models are a capable
both in recovering the entire dose-response as well as in selecting the best treatment and dosage
choices. We note that, in general, we can not calculate the MISE, DPE or PE without knowledge of
the outcome-generating process, since the true dose-response function yn,t(s) is unknown.

Model Architecture. Model structure plays an important role in learning representations for
counterfactual inference with neural networks [7, 9, 35]. A particularly challenging aspect of training
neural networks for counterfactual inference is that the inﬂuence of the treatment indicator variable t
may be lost in high-dimensional hidden representations [9]. To address this problem for the setting
of two available treatments without dosage parameters, Shalit et al. [9] proposed the TARNET
architecture that uses a shared base network and separate head networks for both treatment options.
In TARNETs, the head networks are only trained on samples that received the respective treatment.
Schwab et al. [7] extended the TARNET architecture to the multiple treatment setting by using k
separate head networks, one for each treatment option. In the setting with multiple treatment options
with associated dosage parameters, this problem is further compounded because we must maintain not
only the inﬂuence of t on the hidden representations throughout the network, but also the inﬂuence of
the continuous dosage parameter s. To ensure the inﬂuence of both t and s on hidden representations,
we propose a hierarchical architecture for multiple treatments called dose response network (DRNet,
Figure 1). DRNets ensure that the dosage parameter s maintains its inﬂuence by assigning a head to
N equally-sized dosage strata that subdivide the range of potential dosage parameters
each of E
∈
[at, bt]. The hyperparameter E deﬁnes the trade-off between computational performance and the
resolution (b
a)
E at which the range of dosage values is partitioned. To further attenuate the inﬂuence
−
of the dosage parameter s within the head layers, we additionally repeatedly append s to each hidden
layer in the head layers. We motivate the proposed hierarchical structure with the effectiveness
of the regress and compare approach to counterfactual inference [23], where one builds a separate
estimator for each available treatment option. Separate models for each treatment option suffer
from data-sparsity, since only units that received each respective treatment can be used to train a
per-treatment model and there may not be a large number of samples available for each treatment.
DRNets alleviate the issue of data-sparsity by enabling information to be shared both across the entire
range of dosages through the treatment layers and across treatments through the base layers.

Model Selection. Given multiple models, it is not trivial to decide which model would perform
better at counterfactual tasks, since we in general do not have access to the true dose-response to
calculate error metrics like the ones given above. We therefore use a nearest neighbour approximation
of the MISE to perform model selection using held-out factual data that has not been used for training.
We calculate the nearest neighbour approximation NN-MISE of the MISE using:
T
(cid:88)

N
(cid:88)

(cid:90) bt

(cid:17)2

(cid:16)

NN-MISE =

1
N

1
T

t=1

n=1

s=at

yNN(n),t(s)

ˆyn,t(s)

ds

−

(8)

where we substitute the true dose-response yn,t of the nth sample with the outcome yNN(n),t of an
observed factual nearest neighbour of the nth sample at a dosage point s from the training set. Using

4

∗

Figure 1: The dose response network (DRNet) architecture with shared base layers, k intermediary
treatment layers, and k
E heads for the multiple treatment setting with an associated dosage
parameter s. The shared base layers are trained on all samples, and the treatment layers are only
trained on samples from their respective treatment category. Each treatment layer is further subdivided
into E head layers (only one set of E = 3 head layers for treatment t = 0 is shown above). Each
head layer is assigned a dosage stratum that subdivides the range of potential dosages [at, bt] into E
partitions of equal width (b
a)/E. The head layers each predict outcomes ˆyt(s) for a range of values
of the dosage parameter s, and are only trained on samples that fall within their respective dosage
stratum. The hierarchical structure of DRNets enables them to share common hidden representations
across all samples (base layers), treatment options (treatment layers), and dosage strata (head layers)
while maintaining the inﬂuence of both t and s on the hidden layers.

−

the nearest neighbour approximation of the MISE, we are able to perform model selection without
access to the true counterfactual outcomes y. Among others, nearest neighbour methods have also
been proposed for model selection in the setting with two available treatments without dosages [36].

Regularisation Schemes. DRNets can be combined with regularisation schemes developed to
further address treatment assignment bias. To determine the utility of various regularisation schemes,
we evaluated DRNets using distribution matching [9], propensity dropout [10], matching on the entire
dataset [12], and on the batch level [7]. We naïvely extended these regularisation schemes since
neither of these methods were originally developed for the dose-response setting (Appendix A).

4 Experiments

Our experiments aimed to answer the following questions:

1 How does the performance of our proposed approach compare to state-of-the-art methods for

estimating individual dose-response?

2 How do varying choices of E inﬂuence counterfactual inference performance?
3 How does increasing treatment assignment bias affect the performance of dose-response estimators?

Datasets. Using real-world data, we performed experiments on three semi-synthetic datasets with
two and more treatment options to gain a better understanding of the empirical properties of our
proposed approach. To cover a broad range of settings, we chose datasets with different outcome and
treatment assignment functions, and varying numbers of samples, features and treatments (Table 1).
All three datasets were randomly split into training (63%), validation (27%) and test sets (10%).

News. The News benchmark consisted of 5000 randomly sampled news articles from the NY Times
corpus4 and was originally introduced as a benchmark for counterfactual inference in the setting with
two treatment options without an associated dosage parameter [8]. We extended the original dataset
speciﬁcation [7, 8] to enable the simulation of any number of treatments with associated dosage
R
parameters. The samples X were news articles that consist of word counts xi ∈
(0, 1]
that represent the reader’s opinion of the news item, and a normalised dosage parameter st ∈
that represents the viewer’s reading time. There was a variable number of available treatment options
t that corresponded to various devices that could be used to view the News items, e.g. smartphone,
tablet, desktop, television or others [8]. We trained a topic model on the entire NY Times corpus to
model that consumers prefer to read certain media items on speciﬁc viewing devices. We deﬁned
z(X) as the topic distribution of news item X, and randomly picked k topic space centroids zt and 2k

N, outcomes ys,t ∈

4https://archive.ics.uci.edu/ml/datasets/bag+of+words

5

∈
∼ N

(0.45, 0.15) and standard deviation σ

0, 1 as prototypical news items. We assigned a random Gaussian
topic space centroids zst,i with i
outcome distribution with mean µ
(0.1, 0.05) to each
centroid. For each sample, we drew ideal potential outcomes from that Gaussian outcome distribution
(0, 0.15). The dose response ˜ys was drawn from a distance-weighted
˜yt ∼ N
(µt, σt) + (cid:15) with (cid:15)
∼ N
(µst,1, σst,1) using topic space distances
(µst,0, σst,0) + d1N
d0N
mixture of two Gaussians ˜ys ∼
d = softmax(D(z(X), zst,i)) and the Euclidean distance as distance metric D. We assigned the
Bern(softmax(κ˜yt ˜ys)) with a treatment assignment bias coefﬁcient
observed treatment t using t
x
|
∼
Exp(β) with β = 0.25. The true
κ and an exponentially distributed observed dosage st using st ∼
potential outcomes ys,t = C ˜yt ˜ys were the product of ˜yt and ˜ys scaled by a coefﬁcient C = 50. We
used four different variants of this dataset with k = 2, 4, 8, and 16 viewing devices, and κ = 10,
10, 10, and 7, respectively. Higher values of κ indicate a higher expected treatment assignment bias
depending on ˜yt ˜ys, with κ = 0 indicating no assignment bias.

∼ N

Mechanical Ventilation in the Intensive Care Unit (MVICU). The MVICU benchmark models
patients’ responses to different conﬁguratations of mechanical ventilation in the intensive care
unit. The data was sourced from the publicly available MIMIC III database [37]. The samples X
consisted of the last observed measurements xi of various biosignals, including respiratory, cardiac
and ventilation signals. The outcomes were arterial blood gas readings of the ratio of arterial oxygen
partial pressure to fractional inspired oxygen P aO2/F iO2 which, at values lower than 300, are
used as one of the clinical criteria for the diagnosis Acute Respiratory Distress Syndrome (ARDS)
[38]. We modelled a mechanical ventilator with k = 3 adjustable treatment parameters: (1) the
fraction of inspired oxygen, (2) the positive end-expiratory pressure in the lungs, and (3) tidal volume.
To model the outcomes, we use the same procedure as for the News benchmark with a Gaussian
outcome function and a mixture of Gaussian dose-response function, with the exception that we
did not make use of topic models and instead performed the similarity comparisons D in covariate
space. We used a treatment assignment bias κ = 10 and a scaling coefﬁcient C = 150. Treatment
(µdose,t, 0.1), where the distribution means were deﬁned as
dosages were drawn according to st ∼ N
µdose = (0.6, 0.65, 0.4) for each treatment.

The Cancer Genomic Atlas (TCGA). The TCGA project collected gene expression data from
various types of cancers in 9659 individuals [39]. There were k = 3 available clinical treatment
options: (1) medication, (2) chemotherapy, and (3) surgery. We used a synthetic outcome function
that simulated the risk of cancer recurrence after receiving either of the treatment options based
on the real-world gene expression data. We standardised the gene expression data using the mean
and standard deviations of gene expression at each gene locus for normal tissue in the training
set. To model the outcomes, we followed the same approach as in the MVICU benchmark with
similarity comparisons done in covariate space using the cosine similarity as distance metric D, and
parameterised with κ = 10 and C = 50. Treatment dosages in the TCGA benchmark were drawn
according to st ∼ N

(0.65, 0.1).

Dataset

# Samples # Features # Treatments

News
MVICU
TCGA

5000
8040
9659

2870
49
20531

2/4/8/16
3
3

Table 1: Comparison of the benchmark datasets
used in our experiments. We evaluate on three
semi-synthetic datasets with varying numbers
of treatments and samples.

Figure 2: Analysis of the effect of choosing
various numbers of dosage strata E (x-axis) on
MISE (red), DPE (blue), PE (orange) and Time
needed for training and evaluation (black) as
calculated on the MVICU benchmark. Metrics
were normalised to the range [0, 1]. All other
hyperparameters besides E were held equal.

6

Models. We evaluated DRNet, ablations, baselines, and all relevant state-of-the-art methods: k-
nearest neighbours (kNN) [12], BART [25, 26], CF [20], GANITE [6], TARNET [9], and GPS
[1] using the "causaldrf" package [40]. We evaluated which regularisation strategy for learning
counterfactual representations is most effective by training DRNets using a Wasserstein regulariser
between treatment group distributions (+ Wasserstein) [9], PD (+ PD) [10], batch matching (+ PM)
[7], and matching the entire training set as a preprocessing step [41] using the PM algorithm (+
PSMPM) [7]. To determine whether the DRNet architecture is more effective than its alternatives at
learning representations for counterfactual inference in the presented setting, we also evaluated (1) a
multi-layer perceptron (MLP) that received the treatment index t and dosage s as additional inputs,
and (2) a TARNET for multiple treatments that received the dosage s as an extra input (TARNET)
[7, 8] with all other hyperparameters beside the architecture held equal. As a ﬁnal ablation of DRNet,
we tested whether appending the dosage parameter s to each hidden layer in the head networks is
effective by also training DRNets that only receive the dosage parameter once in the ﬁrst hidden layer
of the head network (- Repeat). We naïvely extended CF, GANITE and BART by adding the dosage
as an additional input covariate, because they were not designed for treatments with dosages.

Hyperparameters. To ensure a fair comparison of the tested models, we took a systematic approach
to hyperparameter search. Each model was given exactly the same number of hyperparameter
optimisation runs with hyperparameters chosen at random from predeﬁned hyperparameter ranges
(Appendix B). We used 5 hyperparameter optimisation runs for each model on TCGA and 10 on
all other benchmarks. Furthermore, we used the same random seed for each model, i.e. all models
were evaluated on exactly the same sets of hyperparameter conﬁgurations. After computing the
hyperparameter runs, we chose the best model based on the validation set NN-MISE. This setup
ensures that each model received the same degree of hyperparameter optimisation. For all DRNets
and ablations, we used E = 5 dosage strata with the exception of those presented in Figure 2.

Metrics. For each dataset and model, we calculated the √MISE, √DPE, and √PE. We used
Romberg integration with 64 equally spaced samples from yn,t and ˆyn,t to compute the inner integral
over the range of dosage parameters necessary for the MISE metric. To compute the optimal dosage
points and treatment options in the DPE and PE, we used Sequential Least Squares Programming
(SLSQP) to determine the respective maxima of yn,t(s) and ˆyn,t(s) numerically.

5 Results and Discussion

In order to evaluate the relative performances of the various methods
Counterfactual Inference.
across a wide range of settings, we compared the MISE of the listed models for counterfactual
inference on the News-2/4/8/16, MVICU and TCGA benchmarks (Table 2; other metrics in Ap-
pendix D). Across the benchmarks, we found that DRNets outperformed all existing state-of-the-art
methods in terms of MISE. We also found that DRNets that used additional regularisation strategies
outperformed vanilla DRNets on News-2, News-4, News-8 and News-16. However, on MVICU and
TCGA, DRNets that used additional regularisation performed similarly as standard DRNets. Where
regularisation was effective, Wasserstein regularisation between treatment groups (+ Wasserstein) and
batch matching (+ PM) were generally slightly more effective than PSMPM and PD. In addition, not
repeating the dosage parameter for each layer in the per-dosage range heads of a DRNet (- Repeat)
performed worse than appending the dosage parameter on News-2, News-4 and News-8. Lastly, the
results showed that DRNet improved upon both TARNET and the MLP baseline by a large margin
across all datasets - demonstrating that the hierarchical dosage subdivision introduced by DRNets

Figure 3: Comparison of DRNet (red), TARNET (blue), MLP (yellow) and GPS (purple) in terms of
their √MISE (top) and √DPE (bottom) for varying levels of treatment assignment bias κ (x-axis) on
News-2. DRNet performs better than other methods across the entire evaluated range of treatment
assignment bias values, and is more robust to increasing levels of κ.

7

Table 2: Comparison of methods for counterfactual inference with multiple parametric treatments
the standard deviation of
on News-2/4/8/16, MVICU and TCGA. We report the mean value
√MISE on the respective test sets over 5 repeat runs with new random seeds. n.r. = not reported for
computational reasons (excessive runtime). †= signiﬁcantly different from DRNet (α < 0.05).

±

Method

DRNet
- Repeat

+ Wasserstein
+ PD
+ PM
+ PSMPM

MLP
TARNET
GANITE

kNN
GPS

CF
BART

News-2

News-4

News-8

News-16

MVICU

TCGA

8.0
† 9.0

† 7.7
† 9.0
† 8.4
† 8.6

†15.3
†15.5
†16.8

†16.2
†47.6

†26.0
†13.8

0.1
0.1

0.2
0.2
0.3
0.1

0.1
0.1
0.1

0.0
0.1

0.0
0.2

±
±

±
±
±
±

±
±
±

±
±

±
±

11.6
†11.9

11.5
†12.2
†12.2
†12.2

†14.5
†15.4
†15.6

†14.7
†24.7

†20.5
†14.0

0.1
0.2

0.0
0.1
0.1
0.2

0.0
0.0
0.1

0.0
0.1

0.0
0.1

±
±

±
±
±
±

±
±
±

±
±

±
±

10.2
10.3

†10.0
†10.6
†11.4
†11.5

†13.9
†14.7
†14.8

†15.0
†22.9

†19.6
†13.0

0.1
0.1

0.0
0.2
0.3
0.2

0.1
0.1
0.1

0.0
0.0

0.0
0.1

±
±

±
±
±
±

±
±
±

±
±

±
±

10.3
10.4

†10.2
10.3
†12.3
†12.2

†14.0
†14.7
†14.8

†14.5
†15.5

†14.9

±
±

±
±
±
±

±
±
±

±
±

±

0.0
0.1

0.0
0.1
0.3
0.3

0.0
0.1
0.0

0.0
0.1

0.0
n.r.

31.1
31.0

32.9
†36.9
31.2
†32.6

†49.5
†58.0
†59.5

†54.9
†78.3

†57.5
†47.1

0.4
0.3

2.9
0.9
0.4
0.5

5.1
4.8
0.8

0.0
0.0

0.0
0.8

±
±

±
±
±
±

±
±
±

±
±

±
±

9.6
10.2

10.2
†11.9
9.7
†11.4

†15.3
†14.7
†15.4

†26.3

†15.2

±
±

±
±
±
±

±
±
±

±

±

0.0
0.2

0.9
1.4
0.2
0.6

0.2
0.1
0.2

n.r.
0.0

0.0
n.r.

is effective, and that an optimised model structure is paramount for learning representations for
counterfactual inference.

Number of Dosage Strata E. To determine the impact of the choice of the number of dosage strata
E on DRNet performance, we analysed the estimation performance and computation time of DRNets
trained with various numbers of dosage strata E on the MVICU benchmark (Figure 2). With all other
hyperparameters held equal, we found that a higher number of dosage strata in general improves
estimation performance, because the resolution at which the dosage range is partitioned is increased.
However, there is a trade-off between resolution and computational performance, as higher values of
E consistently increased the computation time necessary for training and prediction.

Treatment Assignment Bias. To assess the robustness of DRNets and existing methods to increas-
ing levels of treatment assignment bias in observational data, we compared the performance of DRNet
to TARNET, MLP and GPS on the test set of News-2 with varying choices of treatment assignment
bias κ
[5, 20] (Figure 3). We found that DRNet outperformed existing methods across the entire
range of evaluated treatment assignment biases.

∈

Limitations. A general limitation of methods that attempt to estimate causal effects from ob-
servational data is that they are based on untestable assumptions [2]. In this work, we assume
unconfoundedness [1, 33], which implies that one must have reasonable certainty that the available
covariate set X contains the most relevant variables for the problem setting being modelled. Making
this judgement can be difﬁcult in practice, particularly when one does not have much prior knowledge
about the underlying causal process. Even without such certainty, this approach may nonetheless be a
justiﬁable starting point to generate hypotheses when experimental data is not available [42].

6 Conclusion

We presented a deep-learning approach to learning to estimate individual dose-response to multiple
treatments with continuous dosage parameters based on observational data. We extended several
existing regularisation strategies to the setting with any number of treatment options with associated
dosage parameters, and combined them with our approach in order to address treatment assign-
ment bias inherent in observational data. In addition, we introduced performance metrics, model
selection criteria, model architectures, and new open benchmarks for this setting. Our experiments
demonstrated that model structure is paramount in learning neural representations for counterfactual
inference of dose-response curves from observational data, and that there is a trade-off between model
resolution and computational performance in DRNets. DRNets signiﬁcantly outperform existing
state-of-the-art methods in inferring individual dose-response curves across several benchmarks.

8

Acknowledgements

This work was partially funded by the Swiss National Science Foundation (SNSF) project No.
167302 within the National Research Program (NRP) 75 “Big Data”. We gratefully acknowledge the
support of NVIDIA Corporation with the donation of the Titan Xp GPUs used for this research. The
results shown here are in whole or part based upon data generated by the TCGA Research Network:
http://cancergenome.nih.gov/.

References
[1] Guido W Imbens. The role of the propensity score in estimating dose-response functions. Biometrika, 87

(3):706–710, 2000.

[2] Richard Stone. The assumptions on which causal inferences rest. Journal of the Royal Statistical Society.

Series B (Methodological), pages 455–466, 1993.

[3] Judea Pearl. Causality. Cambridge university press, 2009.

[4] Jonas Peters, Dominik Janzing, and Bernhard Schölkopf. Elements of causal inference: foundations and

learning algorithms. MIT press, 2017.

[5] Arthur Schafer. The ethics of the randomized clinical trial. New England Journal of Medicine, 307(12):

719–724, 1982.

[6] Jinsung Yoon, James Jordon, and Mihaela van der Schaar. GANITE: Estimation of Individualized Treatment
Effects using Generative Adversarial Nets. In International Conference on Learning Representations,
2018.

[7] Patrick Schwab, Lorenz Linhardt, and Walter Karlen. Perfect match: A simple method for learning
representations for counterfactual inference with neural networks. arXiv preprint arXiv:1810.00656, 2018.

[8] Fredrik Johansson, Uri Shalit, and David Sontag. Learning representations for counterfactual inference. In

International Conference on Machine Learning, pages 3020–3029, 2016.

[9] Uri Shalit, Fredrik D Johansson, and David Sontag. Estimating individual treatment effect: Generalization

bounds and algorithms. In International Conference on Machine Learning, 2017.

[10] Ahmed M Alaa, Michael Weisz, and Mihaela van der Schaar. Deep counterfactual networks with propensity-

dropout. arXiv preprint arXiv:1706.05966, 2017.

[11] Paul R. Rosenbaum and Donald B. Rubin. The central role of the propensity score in observational studies

for causal effects. Biometrika, 70(1):41–55, 1983.

[12] Daniel E Ho, Kosuke Imai, Gary King, and Elizabeth A Stuart. Matching as nonparametric preprocessing
for reducing model dependence in parametric causal inference. Political analysis, 15(3):199–236, 2007.

[13] Daniel Carpenter. Reputation and power: organizational image and pharmaceutical regulation at the FDA.

Princeton University Press, 2014.

[14] Laura E. Bothwell, Jeremy A. Greene, Scott H. Podolsky, and David S. Jones. Assessing the Gold Standard
— Lessons from the History of RCTs. New England Journal of Medicine, 374(22):2175–2181, 2016.

[15] Clive WJ Granger. Investigating causal relations by econometric models and cross-spectral methods.

Econometrica: Journal of the Econometric Society, pages 424–438, 1969.

[16] Joshua D Angrist, Guido W Imbens, and Donald B Rubin. Identiﬁcation of causal effects using instrumental

variables. Journal of the American statistical Association, 91(434):444–455, 1996.

[17] James M Robins, Miguel Angel Hernan, and Babette Brumback. Marginal structural models and causal

inference in epidemiology. Epidemiology, 11(5):550–560, 2000.

[18] Miguel A Hernán and James M Robins. Using big data to emulate a target trial when a randomized trial is

not available. American journal of epidemiology, 183(8):758–764, 2016.

[19] Brenden M Lake, Tomer D Ullman, Joshua B Tenenbaum, and Samuel J Gershman. Building machines

that learn and think like people. Behavioral and Brain Sciences, 40, 2017.

[20] Stefan Wager and Susan Athey. Estimation and inference of heterogeneous treatment effects using random

forests. Journal of the American Statistical Association, 2017.

9

[21] Ahmed M Alaa and Mihaela van der Schaar. Bayesian inference of individualized treatment effects using
multi-task gaussian processes. In Advances in Neural Information Processing Systems, pages 3424–3432,
2017.

[22] Christos Louizos, Uri Shalit, Joris M Mooij, David Sontag, Richard Zemel, and Max Welling. Causal
effect inference with deep latent-variable models. In Advances in Neural Information Processing Systems,
pages 6446–6456, 2017.

[23] Nathan Kallus. Recursive partitioning for personalization using observational data. In International

Conference on Machine Learning, 2017.

[24] Michele Jonsson Funk, Daniel Westreich, Chris Wiesen, Til Stürmer, M. Alan Brookhart, and Marie
Davidian. Doubly robust estimation of causal effects. American Journal of Epidemiology, 173(7):761–767,
2011.

[25] Hugh A Chipman, Edward I George, Robert E McCulloch, et al. BART: Bayesian additive regression trees.

The Annals of Applied Statistics, 4(1):266–298, 2010.

[26] Hugh Chipman and Robert McCulloch. BayesTree: Bayesian additive regression trees. R package version

0.3-1.4, 2016.

[27] Michael C Knaus, Michael Lechner, and Anthony Strittmatter. Machine learning estimation of heteroge-

neous causal effects: Empirical monte carlo evidence. arXiv preprint arXiv:1810.13237, 2018.

[28] Marco Cuturi. Sinkhorn distances: Lightspeed computation of optimal transport. In Advances in Neural

Information Processing Systems, pages 2292–2300, 2013.

[29] Darwin E Zaske, Patrick Irvine, Linda M Strand, Richard G Strate, Robert J Cipolle, and John Rotschafer.
Wide interpatient variations in gentamicin dose requirements for geriatric patients. JAMA, 248(23):
3122–3126, 1982.

[30] Hans Oldenhof, Martin de Jong, Adri Steenhoek, and Rob Janknegt. Clinical pharmacokinetics of midazo-
lam in intensive care patients, a wide interpatient variability? Clinical Pharmacology & Therapeutics, 43
(3):263–269, 1988.

[31] Charles L Campbell, Susan Smyth, Gilles Montalescot, and Steven R Steinhubl. Aspirin dose for the

prevention of cardiovascular disease: a systematic review. JAMA, 297(18):2018–2024, 2007.

[32] Donald B Rubin. Causal inference using potential outcomes: Design, modeling, decisions. Journal of the

American Statistical Association, 100(469):322–331, 2005.

[33] Michael Lechner. Identiﬁcation and estimation of causal effects of multiple treatments under the conditional
independence assumption. In Econometric Evaluation of Labour Market Policies, pages 43–58. Springer,
2001.

[34] Ricardo Silva. Observational-interventional priors for dose-response learning. In Advances in Neural

Information Processing Systems, pages 1561–1569, 2016.

[35] Ahmed Alaa and Mihaela Schaar. Limits of estimating heterogeneous treatment effects: Guidelines for
practical algorithm design. In International Conference on Machine Learning, pages 129–138, 2018.

[36] Alejandro Schuler, Michael Baiocchi, Robert Tibshirani, and Nigam Shah. A comparison of methods for

model selection when estimating individual treatment effects. arXiv preprint arXiv:1804.05146, 2018.

[37] Mohammed Saeed, Mauricio Villarroel, Andrew T Reisner, Gari D Clifford, Li-Wei Lehman, George
Moody, Thomas Heldt, Tin H Kyaw, Benjamin Moody, and Roger G Mark. Multiparameter Intelligent
Monitoring in Intensive Care II (MIMIC-II): A public-access intensive care unit database. Critical Care
Medicine, 39(5):952, 2011.

[38] Niall D Ferguson, Eddy Fan, Luigi Camporota, Massimo Antonelli, Antonio Anzueto, Richard Beale,
Laurent Brochard, Roy Brower, Andrés Esteban, Luciano Gattinoni, et al. The berlin deﬁnition of ards: an
expanded rationale, justiﬁcation, and supplementary material. Intensive Care Medicine, 38(10):1573–1582,
2012.

[39] John N Weinstein, Eric A Collisson, Gordon B Mills, Kenna R Mills Shaw, Brad A Ozenberger, Kyle
Ellrott, Ilya Shmulevich, Chris Sander, Joshua M Stuart, Cancer Genome Atlas Research Network, et al.
The cancer genome atlas pan-cancer analysis project. Nature genetics, 45(10):1113–1120, 2013.

10

[40] Douglas Galagate. Causal inference with a continuous treatment and outcome: Alternative estimators for
parametric dose-response functions with applications. PhD thesis, University of Maryland, 2016.

[41] Daniel E Ho, Kosuke Imai, Gary King, Elizabeth A Stuart, et al. MatchIt: nonparametric preprocessing for

parametric causal inference. Journal of Statistical Software, 42(8):1–28, 2011.

[42] Guido W Imbens. Nonparametric estimation of average treatment effects under exogeneity: A review.

Review of Economics and statistics, 86(1):4–29, 2004.

11

