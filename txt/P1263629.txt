POST-ACQUISITION IMAGE BASED COMPENSATION FOR THICKNESS VARIATION IN
MICROSCOPY SECTION SERIES

Philipp Hanslovsky, John A. Bogovic, Stephan Saalfeld

HHMI Janelia Research Campus
19700 Helix Drive, Ashburn, VA 20147

5
1
0
2
 
y
a
M
 
7
2
 
 
]

V
C
.
s
c
[
 
 
2
v
0
7
9
6
.
1
1
4
1
:
v
i
X
r
a

ABSTRACT

Serial section Microscopy is an established method for volu-
metric anatomy reconstruction. Section series imaged with
Electron Microscopy are currently vital for the reconstruc-
tion of the synaptic connectivity of entire animal brains such
as that of Drosophila melanogaster. The process of remov-
ing ultrathin layers from a solid block containing the speci-
men, however, is a fragile procedure and has limited preci-
sion with respect to section thickness. We have developed
a method to estimate the relative z-position of each individ-
ual section as a function of signal change across the section
series. First experiments show promising results on both se-
rial section Transmission Electron Microscopy (ssTEM) data
and Focused Ion Beam Scanning Electron Microscopy (FIB-
SEM) series. We made our solution available as Open Source
plugins for the TrakEM2 software and the ImageJ distribution
Fiji.

Index Terms— Serial Section Microscopy, Section

Thickness, Optimization, Fiji

1. INTRODUCTION

Serial section microscopy has been used to study the anatomy
of biological specimens for over 130 years [1]. Today, neu-
roscientists use serial section microscopy to reconstruct the
microcircuitry of animal nervous systems in their entirety.
Electron microscopy (EM) offers the necessary resolution to
resolve individual neuronal processes and synapses [2]. How-
ever, both serial section transmission electron microscopy
(ssTEM), and block-face scanning electron microscopy (BF-
SEM) generate section series with signiﬁcant thickness vari-
ance. In a situation where the size of relevant structures is
close to the resolution-limit imposed by section thickness,
such variance can render accurate reconstruction impossible.
?? top row shows an example of this thickness variance in
a virtual xz-cross-section through a section series acquired
with a focused ion beam milling scanning electron micro-
scope (FIB-SEM).

In order to rectify these distortions, we have developed an
image based method that estimates the position of each in-
dividual section along the z-axis of the volume. Using this

Fig. 1: FIB-SEM series before (top) and after (bottom) sec-
(a) shows an xz-slice through
tion thickness correction.
the volume, (b) shows the corresponding pairwise similar-
ity matrix (PSM) with intensity-encoded normalized cross-
correlation (NCC) values in the same z-coordinate frame. Ar-
rows mark a section range that appears highly compressed in
the original acquisition and biologically plausible after cor-
rection.

information, a corrected volume can be rendered, greatly fa-
cilitating manual and automatic reconstruction efforts.

The underlying observation of our method is that the bio-
logical tissue is a signal whose changing speed varies slowly
across the section series. Sections that are closer to each other
generally look more similar than those farther apart. In addi-
tion, individual sections vary in image quality and may con-
tain preparation artifacts which contributes uncorrelated noise
to the pairwise similarity estimate. We therefore simultane-
ously estimate the decay of simple pairwise similarity mea-
sures as a function of the distance between two sections, the
quality of each individual section, and the optimal position
of each section within the series such that the updated pair-
wise similarity measure is smooth. The result is a unique
z-position for each section, compensating for differences in
thickness (see ?? bottom row). This estimate can be exe-
cuted locally, accounting for varying section thickness across
the section plane. We make our method available as plug-
ins for the TrakEM2 software [3], and the ImageJ distribution
Fiji [4], and have published the source code on GitHub1.

1https://github.com/saalfeldlab/em-thickness-estimation

Published in IEEE International Symposium on Biomedical Imaging, 2015, pages 507–511.

© 2015 IEEE

2. RELATED WORK

The problem of varying thickness in microscopy section se-
ries has been observed and addressed in previous work. De
Groot [5] reviews four different methods to estimate section
thickness: (i) measuring tissue folds that are twice as thick
as the section, (ii) comparing electron scattering in the sec-
tion with a standard test curve, (iii) estimating section thick-
ness from interference patterns that occur when splitting a
light beam and placing the transparent refractile Epon-section
in one of the otherwise identical beam paths, and (iv) re-
embedding the sections, re-sectioning them perpendicularly
to the xy-plane, and then measuring the section thickness
within these sections from subsequent EM. Method (i) de-
pends on an artifact that compromises image quality, options
(ii,iii) require specialized instruments, and option (iv) is not
only laborious but requires that sections can be re-embedded
and re-imaged which is not possible in destructive imaging
modalities such as BF-SEM.

Berlanga et al. [6] manually annotate the top and bottom
surface areas of small image stacks and describe these sur-
faces by polynomial functions. They then transform the im-
age density (RGB-channel values) such that both surface ar-
eas are ﬂat and perpendicular to z. This method requires that
individual sections are acquired as volumes correctly repro-
It is not possible to com-
ducing their physical thickness.
pensate for thickness variation that is the result of physical
compression that differs between adjacent sections.

Boergens and Denk [7] developed an augmentation of the
FIB-SEM to correct for section thickness variation during im-
age acquisition. Later, they ascertain structural isotropy of
the sample and transform z-coordinates such that the peak
of the curve of autocorrelations of several xz-cross-sections
of the data has the same half width in both dimensions. Fi-
nally, the z-coordinate of each section is determined by the
average over all xz-cross-sections. This method enables au-
tomatic estimation of a scaling factor for sufﬁciently large
section ranges that guarantees isotropy of the contained data
assuming that local section thickness is constant.

Sporring et al. [8] operate on image data directly. Sim-
ilar to our method, the position of sections is estimated by
comparing a reference similarity decay curve with pairwise
In contrast with our
similarity estimates between sections.
method, the reference curve is generated from in-section pixel
intensities assuming strictly isotropic specimen. The context
with which a decision is made is limited, since only the pre-

vious section in the series is taken into account for z-position
updates. Noise in individual sections is not considered.

Our method is unique among previous approaches in that
it calculates an accurate globally consistent z-position for
each individual section directly from noisy post-acquisition
image data without further demands on instrument design or
imaging modality.
It has the potential to calculate section
thickness varying in x and y in a straight forward manner and
does not require manual annotations or processing of section
images. As a result, our method readily scales to large EM
data sets being routinely collected.

3. SECTION POSITION ESTIMATION

We start with the assumption that the spatial frequencies of
tissue change slowly across the series of sections. As a re-
sult, the similarities between tissue sections shifted in space
should decay with the magnitude of the shift. Since these tis-
sue properties give rise to the image contrast in microscopy,
we expect similarities between images of the tissue to reﬂect
those properties. Our method corrects section spacing by es-
timating z-shifts that match a locally smooth tissue similarity
decay curve. In our experiments, we have used normalized
cross correlation (NCC) as a measure for similarity. In ad-
dition, we are experimenting with other metrics that are less
sensitive to correct section alignment such as the inverse false
positive rate of invariant feature matches or the average corre-
lation coefﬁcient of local blockmatches. However, regardless
of which similarity metric is employed, the inherent similar-
ity decay curve is generally unknown. It therefore needs to
be estimated from the data while simultaneously correcting
z-coordinates. Furthermore, each section is compromised by
preparation artifacts (varying imaging conditions, differences
in staining, etc.). Assuming that these quality differences ap-
ply to each section individually, the “quality” of a section af-
fects all pairwise comparisons equally.

In ??, we combine these assumptions into an optimization

problem that jointly solves for

1. a “tissue inherent” similarity decay curve,

2. a quality measure for each section, and

3. z-shifts for each section such that observed similarity
curves are best explained by the tissue inherent curve

arg min
ρ,m,s

(cid:32)

(cid:88)

(cid:88)

zref

z

wf (z, zref)

(cid:88)

(cid:16)

ρ(i−z)
zref −

m(zref)m(z)

(c(z), i

R

−

(cid:17)2

z)

(cid:16)

+

m(zref)m(z)

(zref, z

zref)

−

−

ρzref (c(z)

−

(cid:17)2

c(zref))

i

R

+ws(z, zref)

(cid:110)

s(z)

(cid:16)

(cid:16)

ρ−1
zref

−

m(zref)m(z)

(zref, z

zref)

−

R

(cid:17)

(cid:16)

c(z)

−

−

c(zref)(cid:17)(cid:17)(cid:111)2 (cid:33)

.

(1)

508

y
t
i
r
a
l
i

m
S

i

y
t
i
r
a
l
i

m
S

i

4. EXPERIMENTS

We applied our method to two different data sets: (i) FIB-
SEM,2 dimensions 2048×128×1000 px, voxel-size 8×8×2 nm,
and (ii) ssTEM,3 dimensions 2580×3244×63 px, voxel-size
4×4×40 nm. The voxel depth of 2 nm and 40 nm, respec-
tively, is the reported nominal section thickness. As we will
see later, the actual thickness of individual sections varies
greatly.

Distance to reference section

Distance to reference section

(a) Similarity curve estimate

(b) Quality and shifts

4.1. Data Set 1: FIB-SEM

∈

Fig. 2: Iterative optimization: (a) For each section we sam-
Z to the
ple pairwise similarities at integral distances ∆z
reference in transformed space and weight sample contribu-
tion by a windowing function wf centered at the reference
section. ρ(
) is estimated by weighted averaging. We as-
|
sume symmetry, i.e. ρ(
∆z) = ρ(∆z). Function values at
real valued coordinates are generated by linear interpolation.
(b) All pairwise similarity estimates
at updated section po-
sitions are compared with ρ generating a vote for both quality
and position update.

∆z

R

−

|

The section thickness variation in the FIB-SEM image data is
apparent from the xz-cross-section shown in ??. Tissue ap-
pearance changes abruptly from fast to slow at the indicated
section. This indicates a sequence of thicker and thinner sec-
tions, respectively. Our method greatly reduces the severity of
this artifact, as evidenced by the “squeezed” and “stretched”
cross-sections through neuronal processes in the original im-
age that appear round as expected after correction. We es-
timated a min and max section spacing of 0.14 and 10.2 px
(0.28 nm and 20.4 nm) respectively.

z

−

In our notation, z, zref and i are indices for sections, ρ(i)
is the
value of the ﬁt of the similarity localized at z and evaluated at
i
z. wf and ws denote window functions that account for
local smoothness, m is a vector of quality measures for each
section, c holds the actual coordinates for each section, and
s holds the shifts with respect to the original (grid) positions.
(c(z), ∆z) is the measured value of the similarity
Finally,
for reference z at a distance ∆z.

R

This optimization problem has trivial solutions for all
m(z) = 0 and can arbitrarily stretch and compress the se-
ries, both potentially leading to further trivial solutions. We
therefore apply two bounding conditions:

1. ρ(z)

z = 1,

2. the minimum and maximum coordinates of the series
i.e. the series neither shifts nor

remain unchanged,
scales globally.

As there is no closed-form solution to this non-convex op-
timization problem, we approximate ?? by splitting it into
three separate terms that we solve iteratively in alternating
sequence until convergence is reached. Furthermore, an iter-
ative approach gives us maximum ﬂexibility to test a variety
of further regularizing constraints. First, we estimate the sim-
ilarity curve inherent to the tissue from the data (??). Second,
we estimate the quality of each section (??) and, third, we
calculate and apply the shift for each section (??). We repeat
these steps until a speciﬁed number of iterations is reached.

4.2. Data Set 2: ssTEM

In the ssTEM data set, the variances in section thickness are
not as dramatic as in the FIB-SEM data. Therefore, we cor-
rected thickness in the original data set and used the result
as the basis for two revealing simulated data sets: (i) we re-
moved sections from the original series to artiﬁcially create
gaps within the series, and (ii) we randomly reordered sec-
tions in the series. All results are visualized in ??. We down-
sampled the data set by a factor of 10 both in x and y for
isotropic data.

As a numeric measure of quality, we calculate mean and
max absolute difference between estimated z-positions for the
original stack and each modiﬁed stack. Any sections that have
been removed during stack modiﬁcation are ignored for this
evaluation.

Original: The section thicknesses in the ssTEM data do not
vary as much as in the FIB-SEM example. We estimated a
min and max section spacing of 0.6 and 1.6 px (24 nm and
64 nm) respectively. As a result, the corrected ssTEM xz-
cross-sections do not appear dramatically different than the
originals as is the case for FIB-SEM.

Missing Sections: We removed sections 20, 21, 22, 46, 47.
As a result, this stack contains ﬁve fewer sections than the
original and structures are shifted compared to their origi-
nal position (cf. ??). Our method correctly estimates a large

2FIB-SEM of Drosophila melanogaster CNS, courtesy of Ken Hayworth,

Shan Xu, Harald Hess, HHMI Janelia

3ssTEM of Drosophila melanogaster CNS, courtesy of Rick Fetter, Zhi-

hao Zheng, Davi Bock, HHMI Janelia

509

Fig. 3: Results of the method applied to a TEM series and deliberate modiﬁcations. We show an xz-section before (original)
and after correction (corrected), and the corresponding PSM with intensity-encoded NCC values in the same z-coordinate
frame. Arrows mark the places where sections were removed. White horizintal lines demark corresponding z-positions across
all xz-slices and PSMs for visual comparison. The estimated sections positions are almost identical in all three examples.

distance between those sections adjacent to those that were
removed. Due to the applied ﬂoor interpolation in ??, they
are rendered as thick sections (see arrows). The estimated
z-positions of sections deviate from the corresponding z-
positions in the original reference series by 0.13 px (5.2 nm)
on average, and 0.28 px (11.2 nm) at most.

±

Random Order: We randomly reposition each section
4 and then apply our algorithm, al-
within in a range of
lowing for the order of the sections to be changed whenever
indicated by the respective z-coordinates. Our method cor-
rectly recovers the initial order of the sections (??). The es-
timated z-positions of sections deviate from the correspond-
ing z-positions in the original reference series by 0.044 px
(1.76 nm) on average, and 0.13 px (5.2 nm) at most.

4.3. Runtimes

We executed our experiments on a Dell Precision T7610
workstation and measured runtimes for our procedure. Simi-
larity matrix estimation took 62.3 s and inference took 49.4 s
for the FIB-SEM experiment with 1000 sections and 150 it-
erations. These steps took 0.6 s and 0.4 s respectively, for the
TEM-experiments with 63 sections and 100 iterations.

5. DISCUSSION & FUTURE WORK

We developed an efﬁcient image based method to estimate ac-
curate z-positions of all images in microscopy image stacks
with unknown varying z-spacing. Our method can be used
to estimate section thickness in complete section series. In
addition, it can detect missing sections, however, it requires
further inspection to distinguish gaps due to section loss from

thick sections as the method reports only the position of in-
dividual sections. Finally, we demonstrated, that the method
recovers the original section order in moderately randomized
series which is particularly interesting for ssTEM where cor-
rect section order cannot be guaranteed.

In our experiments, we estimated a single z-position for
each section, however, we are planning to extend the method
to estimate thickness variation within sections, employing a
hierarchical coarse-to-ﬁne approach.

In this paper, we tested our method on series of up to
1000 sections with substantial variance in section spacing and
demonstrated its efﬁcacy. Depending solely on one-time es-
timation of pairwise similarity between sections which can
be achieved by sampling and in parallel, our method is not
limited by the size of individual section images. In practice,
we observed that sections that are 1000 or more pixels apart
have very little impact on each other. Therefore, larger se-
ries can be split into independent overlapping batches that are
processed in parallel and merged later. We believe that the
correction of section position will improve the performance
of both manual and automated segmentation methods by pro-
viding more consistent data across sections in z, and will test
this hypothesis in future work.

Our method is Open Source, publicly available in the Im-

ageJ distribution Fiji [4], and integrated in TrakEM2 [3].

6. ACKNOWLEDGEMENTS

This work was supported by HHMI. We thank Davi Bock,
Ken Hayworth, Harald Hess, Rick Fetter, Shan Xu, and Zhi-
hao Zheng for data collection and valuable discussion.

510

References

[1] G. J. Born,

“Die Plattenmodellirmethode,”

Archiv f¨ur

Mikroskopische Anatomie, vol. 22, no. 1, pp. 584–599, 1883.

[2] K. L. Briggman and D. D. Bock, “Volume electron microscopy
for neuronal circuit reconstruction,” Current Opinion in Neuro-
biology, vol. 22, no. 1, pp. 154–161, Feb. 2012.

[3] A. Cardona, S. Saalfeld, J. Schindelin, I. Arganda-Carreras,
et al., “TrakEM2 software for neural circuit reconstruction,”
PLoS ONE, vol. 7, no. 6, pp. e38011, June 2012.

[4] J. Schindelin, I. Arganda-Carreras, E. Frise, V. Kaynig, et al.,
“Fiji: an open-source platform for biological-image analysis,”
Nature Methods, vol. 9, no. 7, pp. 676–682, July 2012.

[5] D. M. De Groot, “Comparison of methods for the estimation
of the thickness of ultrathin tissue sections,” Journal of Mi-
croscopy, vol. 151, no. Pt 1, pp. 23–42, July 1988.

[6] M. L. Berlanga, S. Phan, E. A. Bushong, S. Wu, et al., “Three-
dimensional reconstruction of serial mouse brain sections: So-
lution for ﬂattening high-resolution large-scale mosaics,” Fron-
tiers in Neuroanatomy, vol. 5, Mar. 2011.

[7] K. M. Boergens and W. Denk, “Controlling FIB-SBEM slice
thickness by monitoring the transmitted ion beam,” Journal of
Microscopy, vol. 252, no. 3, pp. 258–262, Dec. 2013.

[8] Jon Sporring, Mahdieh Khanmohammadi, Sune Darkner, Nico-
letta Nava, et al., “Estimating the thickness of ultra thin sections
for electron microscopy by image statistics,” in 2014 IEEE 11th
International Symposium on Biomedical Imaging (ISBI), Apr.
2014, pp. 157–160.

511

POST-ACQUISITION IMAGE BASED COMPENSATION FOR THICKNESS VARIATION IN
MICROSCOPY SECTION SERIES

Philipp Hanslovsky, John A. Bogovic, Stephan Saalfeld

HHMI Janelia Research Campus
19700 Helix Drive, Ashburn, VA 20147

5
1
0
2
 
y
a
M
 
7
2
 
 
]

V
C
.
s
c
[
 
 
2
v
0
7
9
6
.
1
1
4
1
:
v
i
X
r
a

ABSTRACT

Serial section Microscopy is an established method for volu-
metric anatomy reconstruction. Section series imaged with
Electron Microscopy are currently vital for the reconstruc-
tion of the synaptic connectivity of entire animal brains such
as that of Drosophila melanogaster. The process of remov-
ing ultrathin layers from a solid block containing the speci-
men, however, is a fragile procedure and has limited preci-
sion with respect to section thickness. We have developed
a method to estimate the relative z-position of each individ-
ual section as a function of signal change across the section
series. First experiments show promising results on both se-
rial section Transmission Electron Microscopy (ssTEM) data
and Focused Ion Beam Scanning Electron Microscopy (FIB-
SEM) series. We made our solution available as Open Source
plugins for the TrakEM2 software and the ImageJ distribution
Fiji.

Index Terms— Serial Section Microscopy, Section

Thickness, Optimization, Fiji

1. INTRODUCTION

Serial section microscopy has been used to study the anatomy
of biological specimens for over 130 years [1]. Today, neu-
roscientists use serial section microscopy to reconstruct the
microcircuitry of animal nervous systems in their entirety.
Electron microscopy (EM) offers the necessary resolution to
resolve individual neuronal processes and synapses [2]. How-
ever, both serial section transmission electron microscopy
(ssTEM), and block-face scanning electron microscopy (BF-
SEM) generate section series with signiﬁcant thickness vari-
ance. In a situation where the size of relevant structures is
close to the resolution-limit imposed by section thickness,
such variance can render accurate reconstruction impossible.
?? top row shows an example of this thickness variance in
a virtual xz-cross-section through a section series acquired
with a focused ion beam milling scanning electron micro-
scope (FIB-SEM).

In order to rectify these distortions, we have developed an
image based method that estimates the position of each in-
dividual section along the z-axis of the volume. Using this

Fig. 1: FIB-SEM series before (top) and after (bottom) sec-
(a) shows an xz-slice through
tion thickness correction.
the volume, (b) shows the corresponding pairwise similar-
ity matrix (PSM) with intensity-encoded normalized cross-
correlation (NCC) values in the same z-coordinate frame. Ar-
rows mark a section range that appears highly compressed in
the original acquisition and biologically plausible after cor-
rection.

information, a corrected volume can be rendered, greatly fa-
cilitating manual and automatic reconstruction efforts.

The underlying observation of our method is that the bio-
logical tissue is a signal whose changing speed varies slowly
across the section series. Sections that are closer to each other
generally look more similar than those farther apart. In addi-
tion, individual sections vary in image quality and may con-
tain preparation artifacts which contributes uncorrelated noise
to the pairwise similarity estimate. We therefore simultane-
ously estimate the decay of simple pairwise similarity mea-
sures as a function of the distance between two sections, the
quality of each individual section, and the optimal position
of each section within the series such that the updated pair-
wise similarity measure is smooth. The result is a unique
z-position for each section, compensating for differences in
thickness (see ?? bottom row). This estimate can be exe-
cuted locally, accounting for varying section thickness across
the section plane. We make our method available as plug-
ins for the TrakEM2 software [3], and the ImageJ distribution
Fiji [4], and have published the source code on GitHub1.

1https://github.com/saalfeldlab/em-thickness-estimation

Published in IEEE International Symposium on Biomedical Imaging, 2015, pages 507–511.

© 2015 IEEE

2. RELATED WORK

The problem of varying thickness in microscopy section se-
ries has been observed and addressed in previous work. De
Groot [5] reviews four different methods to estimate section
thickness: (i) measuring tissue folds that are twice as thick
as the section, (ii) comparing electron scattering in the sec-
tion with a standard test curve, (iii) estimating section thick-
ness from interference patterns that occur when splitting a
light beam and placing the transparent refractile Epon-section
in one of the otherwise identical beam paths, and (iv) re-
embedding the sections, re-sectioning them perpendicularly
to the xy-plane, and then measuring the section thickness
within these sections from subsequent EM. Method (i) de-
pends on an artifact that compromises image quality, options
(ii,iii) require specialized instruments, and option (iv) is not
only laborious but requires that sections can be re-embedded
and re-imaged which is not possible in destructive imaging
modalities such as BF-SEM.

Berlanga et al. [6] manually annotate the top and bottom
surface areas of small image stacks and describe these sur-
faces by polynomial functions. They then transform the im-
age density (RGB-channel values) such that both surface ar-
eas are ﬂat and perpendicular to z. This method requires that
individual sections are acquired as volumes correctly repro-
It is not possible to com-
ducing their physical thickness.
pensate for thickness variation that is the result of physical
compression that differs between adjacent sections.

Boergens and Denk [7] developed an augmentation of the
FIB-SEM to correct for section thickness variation during im-
age acquisition. Later, they ascertain structural isotropy of
the sample and transform z-coordinates such that the peak
of the curve of autocorrelations of several xz-cross-sections
of the data has the same half width in both dimensions. Fi-
nally, the z-coordinate of each section is determined by the
average over all xz-cross-sections. This method enables au-
tomatic estimation of a scaling factor for sufﬁciently large
section ranges that guarantees isotropy of the contained data
assuming that local section thickness is constant.

Sporring et al. [8] operate on image data directly. Sim-
ilar to our method, the position of sections is estimated by
comparing a reference similarity decay curve with pairwise
In contrast with our
similarity estimates between sections.
method, the reference curve is generated from in-section pixel
intensities assuming strictly isotropic specimen. The context
with which a decision is made is limited, since only the pre-

vious section in the series is taken into account for z-position
updates. Noise in individual sections is not considered.

Our method is unique among previous approaches in that
it calculates an accurate globally consistent z-position for
each individual section directly from noisy post-acquisition
image data without further demands on instrument design or
imaging modality.
It has the potential to calculate section
thickness varying in x and y in a straight forward manner and
does not require manual annotations or processing of section
images. As a result, our method readily scales to large EM
data sets being routinely collected.

3. SECTION POSITION ESTIMATION

We start with the assumption that the spatial frequencies of
tissue change slowly across the series of sections. As a re-
sult, the similarities between tissue sections shifted in space
should decay with the magnitude of the shift. Since these tis-
sue properties give rise to the image contrast in microscopy,
we expect similarities between images of the tissue to reﬂect
those properties. Our method corrects section spacing by es-
timating z-shifts that match a locally smooth tissue similarity
decay curve. In our experiments, we have used normalized
cross correlation (NCC) as a measure for similarity. In ad-
dition, we are experimenting with other metrics that are less
sensitive to correct section alignment such as the inverse false
positive rate of invariant feature matches or the average corre-
lation coefﬁcient of local blockmatches. However, regardless
of which similarity metric is employed, the inherent similar-
ity decay curve is generally unknown. It therefore needs to
be estimated from the data while simultaneously correcting
z-coordinates. Furthermore, each section is compromised by
preparation artifacts (varying imaging conditions, differences
in staining, etc.). Assuming that these quality differences ap-
ply to each section individually, the “quality” of a section af-
fects all pairwise comparisons equally.

In ??, we combine these assumptions into an optimization

problem that jointly solves for

1. a “tissue inherent” similarity decay curve,

2. a quality measure for each section, and

3. z-shifts for each section such that observed similarity
curves are best explained by the tissue inherent curve

arg min
ρ,m,s

(cid:32)

(cid:88)

(cid:88)

zref

z

wf (z, zref)

(cid:88)

(cid:16)

ρ(i−z)
zref −

m(zref)m(z)

(c(z), i

R

−

(cid:17)2

z)

(cid:16)

+

m(zref)m(z)

(zref, z

zref)

−

−

ρzref (c(z)

−

(cid:17)2

c(zref))

i

R

+ws(z, zref)

(cid:110)

s(z)

(cid:16)

(cid:16)

ρ−1
zref

−

m(zref)m(z)

(zref, z

zref)

−

R

(cid:17)

(cid:16)

c(z)

−

−

c(zref)(cid:17)(cid:17)(cid:111)2 (cid:33)

.

(1)

508

y
t
i
r
a
l
i

m
S

i

y
t
i
r
a
l
i

m
S

i

4. EXPERIMENTS

We applied our method to two different data sets: (i) FIB-
SEM,2 dimensions 2048×128×1000 px, voxel-size 8×8×2 nm,
and (ii) ssTEM,3 dimensions 2580×3244×63 px, voxel-size
4×4×40 nm. The voxel depth of 2 nm and 40 nm, respec-
tively, is the reported nominal section thickness. As we will
see later, the actual thickness of individual sections varies
greatly.

Distance to reference section

Distance to reference section

(a) Similarity curve estimate

(b) Quality and shifts

4.1. Data Set 1: FIB-SEM

∈

Fig. 2: Iterative optimization: (a) For each section we sam-
Z to the
ple pairwise similarities at integral distances ∆z
reference in transformed space and weight sample contribu-
tion by a windowing function wf centered at the reference
section. ρ(
) is estimated by weighted averaging. We as-
|
sume symmetry, i.e. ρ(
∆z) = ρ(∆z). Function values at
real valued coordinates are generated by linear interpolation.
(b) All pairwise similarity estimates
at updated section po-
sitions are compared with ρ generating a vote for both quality
and position update.

∆z

R

−

|

The section thickness variation in the FIB-SEM image data is
apparent from the xz-cross-section shown in ??. Tissue ap-
pearance changes abruptly from fast to slow at the indicated
section. This indicates a sequence of thicker and thinner sec-
tions, respectively. Our method greatly reduces the severity of
this artifact, as evidenced by the “squeezed” and “stretched”
cross-sections through neuronal processes in the original im-
age that appear round as expected after correction. We es-
timated a min and max section spacing of 0.14 and 10.2 px
(0.28 nm and 20.4 nm) respectively.

z

−

In our notation, z, zref and i are indices for sections, ρ(i)
is the
value of the ﬁt of the similarity localized at z and evaluated at
i
z. wf and ws denote window functions that account for
local smoothness, m is a vector of quality measures for each
section, c holds the actual coordinates for each section, and
s holds the shifts with respect to the original (grid) positions.
(c(z), ∆z) is the measured value of the similarity
Finally,
for reference z at a distance ∆z.

R

This optimization problem has trivial solutions for all
m(z) = 0 and can arbitrarily stretch and compress the se-
ries, both potentially leading to further trivial solutions. We
therefore apply two bounding conditions:

1. ρ(z)

z = 1,

2. the minimum and maximum coordinates of the series
i.e. the series neither shifts nor

remain unchanged,
scales globally.

As there is no closed-form solution to this non-convex op-
timization problem, we approximate ?? by splitting it into
three separate terms that we solve iteratively in alternating
sequence until convergence is reached. Furthermore, an iter-
ative approach gives us maximum ﬂexibility to test a variety
of further regularizing constraints. First, we estimate the sim-
ilarity curve inherent to the tissue from the data (??). Second,
we estimate the quality of each section (??) and, third, we
calculate and apply the shift for each section (??). We repeat
these steps until a speciﬁed number of iterations is reached.

4.2. Data Set 2: ssTEM

In the ssTEM data set, the variances in section thickness are
not as dramatic as in the FIB-SEM data. Therefore, we cor-
rected thickness in the original data set and used the result
as the basis for two revealing simulated data sets: (i) we re-
moved sections from the original series to artiﬁcially create
gaps within the series, and (ii) we randomly reordered sec-
tions in the series. All results are visualized in ??. We down-
sampled the data set by a factor of 10 both in x and y for
isotropic data.

As a numeric measure of quality, we calculate mean and
max absolute difference between estimated z-positions for the
original stack and each modiﬁed stack. Any sections that have
been removed during stack modiﬁcation are ignored for this
evaluation.

Original: The section thicknesses in the ssTEM data do not
vary as much as in the FIB-SEM example. We estimated a
min and max section spacing of 0.6 and 1.6 px (24 nm and
64 nm) respectively. As a result, the corrected ssTEM xz-
cross-sections do not appear dramatically different than the
originals as is the case for FIB-SEM.

Missing Sections: We removed sections 20, 21, 22, 46, 47.
As a result, this stack contains ﬁve fewer sections than the
original and structures are shifted compared to their origi-
nal position (cf. ??). Our method correctly estimates a large

2FIB-SEM of Drosophila melanogaster CNS, courtesy of Ken Hayworth,

Shan Xu, Harald Hess, HHMI Janelia

3ssTEM of Drosophila melanogaster CNS, courtesy of Rick Fetter, Zhi-

hao Zheng, Davi Bock, HHMI Janelia

509

Fig. 3: Results of the method applied to a TEM series and deliberate modiﬁcations. We show an xz-section before (original)
and after correction (corrected), and the corresponding PSM with intensity-encoded NCC values in the same z-coordinate
frame. Arrows mark the places where sections were removed. White horizintal lines demark corresponding z-positions across
all xz-slices and PSMs for visual comparison. The estimated sections positions are almost identical in all three examples.

distance between those sections adjacent to those that were
removed. Due to the applied ﬂoor interpolation in ??, they
are rendered as thick sections (see arrows). The estimated
z-positions of sections deviate from the corresponding z-
positions in the original reference series by 0.13 px (5.2 nm)
on average, and 0.28 px (11.2 nm) at most.

±

Random Order: We randomly reposition each section
4 and then apply our algorithm, al-
within in a range of
lowing for the order of the sections to be changed whenever
indicated by the respective z-coordinates. Our method cor-
rectly recovers the initial order of the sections (??). The es-
timated z-positions of sections deviate from the correspond-
ing z-positions in the original reference series by 0.044 px
(1.76 nm) on average, and 0.13 px (5.2 nm) at most.

4.3. Runtimes

We executed our experiments on a Dell Precision T7610
workstation and measured runtimes for our procedure. Simi-
larity matrix estimation took 62.3 s and inference took 49.4 s
for the FIB-SEM experiment with 1000 sections and 150 it-
erations. These steps took 0.6 s and 0.4 s respectively, for the
TEM-experiments with 63 sections and 100 iterations.

5. DISCUSSION & FUTURE WORK

We developed an efﬁcient image based method to estimate ac-
curate z-positions of all images in microscopy image stacks
with unknown varying z-spacing. Our method can be used
to estimate section thickness in complete section series. In
addition, it can detect missing sections, however, it requires
further inspection to distinguish gaps due to section loss from

thick sections as the method reports only the position of in-
dividual sections. Finally, we demonstrated, that the method
recovers the original section order in moderately randomized
series which is particularly interesting for ssTEM where cor-
rect section order cannot be guaranteed.

In our experiments, we estimated a single z-position for
each section, however, we are planning to extend the method
to estimate thickness variation within sections, employing a
hierarchical coarse-to-ﬁne approach.

In this paper, we tested our method on series of up to
1000 sections with substantial variance in section spacing and
demonstrated its efﬁcacy. Depending solely on one-time es-
timation of pairwise similarity between sections which can
be achieved by sampling and in parallel, our method is not
limited by the size of individual section images. In practice,
we observed that sections that are 1000 or more pixels apart
have very little impact on each other. Therefore, larger se-
ries can be split into independent overlapping batches that are
processed in parallel and merged later. We believe that the
correction of section position will improve the performance
of both manual and automated segmentation methods by pro-
viding more consistent data across sections in z, and will test
this hypothesis in future work.

Our method is Open Source, publicly available in the Im-

ageJ distribution Fiji [4], and integrated in TrakEM2 [3].

6. ACKNOWLEDGEMENTS

This work was supported by HHMI. We thank Davi Bock,
Ken Hayworth, Harald Hess, Rick Fetter, Shan Xu, and Zhi-
hao Zheng for data collection and valuable discussion.

510

References

[1] G. J. Born,

“Die Plattenmodellirmethode,”

Archiv f¨ur

Mikroskopische Anatomie, vol. 22, no. 1, pp. 584–599, 1883.

[2] K. L. Briggman and D. D. Bock, “Volume electron microscopy
for neuronal circuit reconstruction,” Current Opinion in Neuro-
biology, vol. 22, no. 1, pp. 154–161, Feb. 2012.

[3] A. Cardona, S. Saalfeld, J. Schindelin, I. Arganda-Carreras,
et al., “TrakEM2 software for neural circuit reconstruction,”
PLoS ONE, vol. 7, no. 6, pp. e38011, June 2012.

[4] J. Schindelin, I. Arganda-Carreras, E. Frise, V. Kaynig, et al.,
“Fiji: an open-source platform for biological-image analysis,”
Nature Methods, vol. 9, no. 7, pp. 676–682, July 2012.

[5] D. M. De Groot, “Comparison of methods for the estimation
of the thickness of ultrathin tissue sections,” Journal of Mi-
croscopy, vol. 151, no. Pt 1, pp. 23–42, July 1988.

[6] M. L. Berlanga, S. Phan, E. A. Bushong, S. Wu, et al., “Three-
dimensional reconstruction of serial mouse brain sections: So-
lution for ﬂattening high-resolution large-scale mosaics,” Fron-
tiers in Neuroanatomy, vol. 5, Mar. 2011.

[7] K. M. Boergens and W. Denk, “Controlling FIB-SBEM slice
thickness by monitoring the transmitted ion beam,” Journal of
Microscopy, vol. 252, no. 3, pp. 258–262, Dec. 2013.

[8] Jon Sporring, Mahdieh Khanmohammadi, Sune Darkner, Nico-
letta Nava, et al., “Estimating the thickness of ultra thin sections
for electron microscopy by image statistics,” in 2014 IEEE 11th
International Symposium on Biomedical Imaging (ISBI), Apr.
2014, pp. 157–160.

511

POST-ACQUISITION IMAGE BASED COMPENSATION FOR THICKNESS VARIATION IN
MICROSCOPY SECTION SERIES

Philipp Hanslovsky, John A. Bogovic, Stephan Saalfeld

HHMI Janelia Research Campus
19700 Helix Drive, Ashburn, VA 20147

5
1
0
2
 
y
a
M
 
7
2
 
 
]

V
C
.
s
c
[
 
 
2
v
0
7
9
6
.
1
1
4
1
:
v
i
X
r
a

ABSTRACT

Serial section Microscopy is an established method for volu-
metric anatomy reconstruction. Section series imaged with
Electron Microscopy are currently vital for the reconstruc-
tion of the synaptic connectivity of entire animal brains such
as that of Drosophila melanogaster. The process of remov-
ing ultrathin layers from a solid block containing the speci-
men, however, is a fragile procedure and has limited preci-
sion with respect to section thickness. We have developed
a method to estimate the relative z-position of each individ-
ual section as a function of signal change across the section
series. First experiments show promising results on both se-
rial section Transmission Electron Microscopy (ssTEM) data
and Focused Ion Beam Scanning Electron Microscopy (FIB-
SEM) series. We made our solution available as Open Source
plugins for the TrakEM2 software and the ImageJ distribution
Fiji.

Index Terms— Serial Section Microscopy, Section

Thickness, Optimization, Fiji

1. INTRODUCTION

Serial section microscopy has been used to study the anatomy
of biological specimens for over 130 years [1]. Today, neu-
roscientists use serial section microscopy to reconstruct the
microcircuitry of animal nervous systems in their entirety.
Electron microscopy (EM) offers the necessary resolution to
resolve individual neuronal processes and synapses [2]. How-
ever, both serial section transmission electron microscopy
(ssTEM), and block-face scanning electron microscopy (BF-
SEM) generate section series with signiﬁcant thickness vari-
ance. In a situation where the size of relevant structures is
close to the resolution-limit imposed by section thickness,
such variance can render accurate reconstruction impossible.
?? top row shows an example of this thickness variance in
a virtual xz-cross-section through a section series acquired
with a focused ion beam milling scanning electron micro-
scope (FIB-SEM).

In order to rectify these distortions, we have developed an
image based method that estimates the position of each in-
dividual section along the z-axis of the volume. Using this

Fig. 1: FIB-SEM series before (top) and after (bottom) sec-
(a) shows an xz-slice through
tion thickness correction.
the volume, (b) shows the corresponding pairwise similar-
ity matrix (PSM) with intensity-encoded normalized cross-
correlation (NCC) values in the same z-coordinate frame. Ar-
rows mark a section range that appears highly compressed in
the original acquisition and biologically plausible after cor-
rection.

information, a corrected volume can be rendered, greatly fa-
cilitating manual and automatic reconstruction efforts.

The underlying observation of our method is that the bio-
logical tissue is a signal whose changing speed varies slowly
across the section series. Sections that are closer to each other
generally look more similar than those farther apart. In addi-
tion, individual sections vary in image quality and may con-
tain preparation artifacts which contributes uncorrelated noise
to the pairwise similarity estimate. We therefore simultane-
ously estimate the decay of simple pairwise similarity mea-
sures as a function of the distance between two sections, the
quality of each individual section, and the optimal position
of each section within the series such that the updated pair-
wise similarity measure is smooth. The result is a unique
z-position for each section, compensating for differences in
thickness (see ?? bottom row). This estimate can be exe-
cuted locally, accounting for varying section thickness across
the section plane. We make our method available as plug-
ins for the TrakEM2 software [3], and the ImageJ distribution
Fiji [4], and have published the source code on GitHub1.

1https://github.com/saalfeldlab/em-thickness-estimation

Published in IEEE International Symposium on Biomedical Imaging, 2015, pages 507–511.

© 2015 IEEE

2. RELATED WORK

The problem of varying thickness in microscopy section se-
ries has been observed and addressed in previous work. De
Groot [5] reviews four different methods to estimate section
thickness: (i) measuring tissue folds that are twice as thick
as the section, (ii) comparing electron scattering in the sec-
tion with a standard test curve, (iii) estimating section thick-
ness from interference patterns that occur when splitting a
light beam and placing the transparent refractile Epon-section
in one of the otherwise identical beam paths, and (iv) re-
embedding the sections, re-sectioning them perpendicularly
to the xy-plane, and then measuring the section thickness
within these sections from subsequent EM. Method (i) de-
pends on an artifact that compromises image quality, options
(ii,iii) require specialized instruments, and option (iv) is not
only laborious but requires that sections can be re-embedded
and re-imaged which is not possible in destructive imaging
modalities such as BF-SEM.

Berlanga et al. [6] manually annotate the top and bottom
surface areas of small image stacks and describe these sur-
faces by polynomial functions. They then transform the im-
age density (RGB-channel values) such that both surface ar-
eas are ﬂat and perpendicular to z. This method requires that
individual sections are acquired as volumes correctly repro-
It is not possible to com-
ducing their physical thickness.
pensate for thickness variation that is the result of physical
compression that differs between adjacent sections.

Boergens and Denk [7] developed an augmentation of the
FIB-SEM to correct for section thickness variation during im-
age acquisition. Later, they ascertain structural isotropy of
the sample and transform z-coordinates such that the peak
of the curve of autocorrelations of several xz-cross-sections
of the data has the same half width in both dimensions. Fi-
nally, the z-coordinate of each section is determined by the
average over all xz-cross-sections. This method enables au-
tomatic estimation of a scaling factor for sufﬁciently large
section ranges that guarantees isotropy of the contained data
assuming that local section thickness is constant.

Sporring et al. [8] operate on image data directly. Sim-
ilar to our method, the position of sections is estimated by
comparing a reference similarity decay curve with pairwise
In contrast with our
similarity estimates between sections.
method, the reference curve is generated from in-section pixel
intensities assuming strictly isotropic specimen. The context
with which a decision is made is limited, since only the pre-

vious section in the series is taken into account for z-position
updates. Noise in individual sections is not considered.

Our method is unique among previous approaches in that
it calculates an accurate globally consistent z-position for
each individual section directly from noisy post-acquisition
image data without further demands on instrument design or
imaging modality.
It has the potential to calculate section
thickness varying in x and y in a straight forward manner and
does not require manual annotations or processing of section
images. As a result, our method readily scales to large EM
data sets being routinely collected.

3. SECTION POSITION ESTIMATION

We start with the assumption that the spatial frequencies of
tissue change slowly across the series of sections. As a re-
sult, the similarities between tissue sections shifted in space
should decay with the magnitude of the shift. Since these tis-
sue properties give rise to the image contrast in microscopy,
we expect similarities between images of the tissue to reﬂect
those properties. Our method corrects section spacing by es-
timating z-shifts that match a locally smooth tissue similarity
decay curve. In our experiments, we have used normalized
cross correlation (NCC) as a measure for similarity. In ad-
dition, we are experimenting with other metrics that are less
sensitive to correct section alignment such as the inverse false
positive rate of invariant feature matches or the average corre-
lation coefﬁcient of local blockmatches. However, regardless
of which similarity metric is employed, the inherent similar-
ity decay curve is generally unknown. It therefore needs to
be estimated from the data while simultaneously correcting
z-coordinates. Furthermore, each section is compromised by
preparation artifacts (varying imaging conditions, differences
in staining, etc.). Assuming that these quality differences ap-
ply to each section individually, the “quality” of a section af-
fects all pairwise comparisons equally.

In ??, we combine these assumptions into an optimization

problem that jointly solves for

1. a “tissue inherent” similarity decay curve,

2. a quality measure for each section, and

3. z-shifts for each section such that observed similarity
curves are best explained by the tissue inherent curve

arg min
ρ,m,s

(cid:32)

(cid:88)

(cid:88)

zref

z

wf (z, zref)

(cid:88)

(cid:16)

ρ(i−z)
zref −

m(zref)m(z)

(c(z), i

R

−

(cid:17)2

z)

(cid:16)

+

m(zref)m(z)

(zref, z

zref)

−

−

ρzref (c(z)

−

(cid:17)2

c(zref))

i

R

+ws(z, zref)

(cid:110)

s(z)

(cid:16)

(cid:16)

ρ−1
zref

−

m(zref)m(z)

(zref, z

zref)

−

R

(cid:17)

(cid:16)

c(z)

−

−

c(zref)(cid:17)(cid:17)(cid:111)2 (cid:33)

.

(1)

508

y
t
i
r
a
l
i

m
S

i

y
t
i
r
a
l
i

m
S

i

4. EXPERIMENTS

We applied our method to two different data sets: (i) FIB-
SEM,2 dimensions 2048×128×1000 px, voxel-size 8×8×2 nm,
and (ii) ssTEM,3 dimensions 2580×3244×63 px, voxel-size
4×4×40 nm. The voxel depth of 2 nm and 40 nm, respec-
tively, is the reported nominal section thickness. As we will
see later, the actual thickness of individual sections varies
greatly.

Distance to reference section

Distance to reference section

(a) Similarity curve estimate

(b) Quality and shifts

4.1. Data Set 1: FIB-SEM

∈

Fig. 2: Iterative optimization: (a) For each section we sam-
Z to the
ple pairwise similarities at integral distances ∆z
reference in transformed space and weight sample contribu-
tion by a windowing function wf centered at the reference
section. ρ(
) is estimated by weighted averaging. We as-
|
sume symmetry, i.e. ρ(
∆z) = ρ(∆z). Function values at
real valued coordinates are generated by linear interpolation.
(b) All pairwise similarity estimates
at updated section po-
sitions are compared with ρ generating a vote for both quality
and position update.

∆z

R

−

|

The section thickness variation in the FIB-SEM image data is
apparent from the xz-cross-section shown in ??. Tissue ap-
pearance changes abruptly from fast to slow at the indicated
section. This indicates a sequence of thicker and thinner sec-
tions, respectively. Our method greatly reduces the severity of
this artifact, as evidenced by the “squeezed” and “stretched”
cross-sections through neuronal processes in the original im-
age that appear round as expected after correction. We es-
timated a min and max section spacing of 0.14 and 10.2 px
(0.28 nm and 20.4 nm) respectively.

z

−

In our notation, z, zref and i are indices for sections, ρ(i)
is the
value of the ﬁt of the similarity localized at z and evaluated at
i
z. wf and ws denote window functions that account for
local smoothness, m is a vector of quality measures for each
section, c holds the actual coordinates for each section, and
s holds the shifts with respect to the original (grid) positions.
(c(z), ∆z) is the measured value of the similarity
Finally,
for reference z at a distance ∆z.

R

This optimization problem has trivial solutions for all
m(z) = 0 and can arbitrarily stretch and compress the se-
ries, both potentially leading to further trivial solutions. We
therefore apply two bounding conditions:

1. ρ(z)

z = 1,

2. the minimum and maximum coordinates of the series
i.e. the series neither shifts nor

remain unchanged,
scales globally.

As there is no closed-form solution to this non-convex op-
timization problem, we approximate ?? by splitting it into
three separate terms that we solve iteratively in alternating
sequence until convergence is reached. Furthermore, an iter-
ative approach gives us maximum ﬂexibility to test a variety
of further regularizing constraints. First, we estimate the sim-
ilarity curve inherent to the tissue from the data (??). Second,
we estimate the quality of each section (??) and, third, we
calculate and apply the shift for each section (??). We repeat
these steps until a speciﬁed number of iterations is reached.

4.2. Data Set 2: ssTEM

In the ssTEM data set, the variances in section thickness are
not as dramatic as in the FIB-SEM data. Therefore, we cor-
rected thickness in the original data set and used the result
as the basis for two revealing simulated data sets: (i) we re-
moved sections from the original series to artiﬁcially create
gaps within the series, and (ii) we randomly reordered sec-
tions in the series. All results are visualized in ??. We down-
sampled the data set by a factor of 10 both in x and y for
isotropic data.

As a numeric measure of quality, we calculate mean and
max absolute difference between estimated z-positions for the
original stack and each modiﬁed stack. Any sections that have
been removed during stack modiﬁcation are ignored for this
evaluation.

Original: The section thicknesses in the ssTEM data do not
vary as much as in the FIB-SEM example. We estimated a
min and max section spacing of 0.6 and 1.6 px (24 nm and
64 nm) respectively. As a result, the corrected ssTEM xz-
cross-sections do not appear dramatically different than the
originals as is the case for FIB-SEM.

Missing Sections: We removed sections 20, 21, 22, 46, 47.
As a result, this stack contains ﬁve fewer sections than the
original and structures are shifted compared to their origi-
nal position (cf. ??). Our method correctly estimates a large

2FIB-SEM of Drosophila melanogaster CNS, courtesy of Ken Hayworth,

Shan Xu, Harald Hess, HHMI Janelia

3ssTEM of Drosophila melanogaster CNS, courtesy of Rick Fetter, Zhi-

hao Zheng, Davi Bock, HHMI Janelia

509

Fig. 3: Results of the method applied to a TEM series and deliberate modiﬁcations. We show an xz-section before (original)
and after correction (corrected), and the corresponding PSM with intensity-encoded NCC values in the same z-coordinate
frame. Arrows mark the places where sections were removed. White horizintal lines demark corresponding z-positions across
all xz-slices and PSMs for visual comparison. The estimated sections positions are almost identical in all three examples.

distance between those sections adjacent to those that were
removed. Due to the applied ﬂoor interpolation in ??, they
are rendered as thick sections (see arrows). The estimated
z-positions of sections deviate from the corresponding z-
positions in the original reference series by 0.13 px (5.2 nm)
on average, and 0.28 px (11.2 nm) at most.

±

Random Order: We randomly reposition each section
4 and then apply our algorithm, al-
within in a range of
lowing for the order of the sections to be changed whenever
indicated by the respective z-coordinates. Our method cor-
rectly recovers the initial order of the sections (??). The es-
timated z-positions of sections deviate from the correspond-
ing z-positions in the original reference series by 0.044 px
(1.76 nm) on average, and 0.13 px (5.2 nm) at most.

4.3. Runtimes

We executed our experiments on a Dell Precision T7610
workstation and measured runtimes for our procedure. Simi-
larity matrix estimation took 62.3 s and inference took 49.4 s
for the FIB-SEM experiment with 1000 sections and 150 it-
erations. These steps took 0.6 s and 0.4 s respectively, for the
TEM-experiments with 63 sections and 100 iterations.

5. DISCUSSION & FUTURE WORK

We developed an efﬁcient image based method to estimate ac-
curate z-positions of all images in microscopy image stacks
with unknown varying z-spacing. Our method can be used
to estimate section thickness in complete section series. In
addition, it can detect missing sections, however, it requires
further inspection to distinguish gaps due to section loss from

thick sections as the method reports only the position of in-
dividual sections. Finally, we demonstrated, that the method
recovers the original section order in moderately randomized
series which is particularly interesting for ssTEM where cor-
rect section order cannot be guaranteed.

In our experiments, we estimated a single z-position for
each section, however, we are planning to extend the method
to estimate thickness variation within sections, employing a
hierarchical coarse-to-ﬁne approach.

In this paper, we tested our method on series of up to
1000 sections with substantial variance in section spacing and
demonstrated its efﬁcacy. Depending solely on one-time es-
timation of pairwise similarity between sections which can
be achieved by sampling and in parallel, our method is not
limited by the size of individual section images. In practice,
we observed that sections that are 1000 or more pixels apart
have very little impact on each other. Therefore, larger se-
ries can be split into independent overlapping batches that are
processed in parallel and merged later. We believe that the
correction of section position will improve the performance
of both manual and automated segmentation methods by pro-
viding more consistent data across sections in z, and will test
this hypothesis in future work.

Our method is Open Source, publicly available in the Im-

ageJ distribution Fiji [4], and integrated in TrakEM2 [3].

6. ACKNOWLEDGEMENTS

This work was supported by HHMI. We thank Davi Bock,
Ken Hayworth, Harald Hess, Rick Fetter, Shan Xu, and Zhi-
hao Zheng for data collection and valuable discussion.

510

References

[1] G. J. Born,

“Die Plattenmodellirmethode,”

Archiv f¨ur

Mikroskopische Anatomie, vol. 22, no. 1, pp. 584–599, 1883.

[2] K. L. Briggman and D. D. Bock, “Volume electron microscopy
for neuronal circuit reconstruction,” Current Opinion in Neuro-
biology, vol. 22, no. 1, pp. 154–161, Feb. 2012.

[3] A. Cardona, S. Saalfeld, J. Schindelin, I. Arganda-Carreras,
et al., “TrakEM2 software for neural circuit reconstruction,”
PLoS ONE, vol. 7, no. 6, pp. e38011, June 2012.

[4] J. Schindelin, I. Arganda-Carreras, E. Frise, V. Kaynig, et al.,
“Fiji: an open-source platform for biological-image analysis,”
Nature Methods, vol. 9, no. 7, pp. 676–682, July 2012.

[5] D. M. De Groot, “Comparison of methods for the estimation
of the thickness of ultrathin tissue sections,” Journal of Mi-
croscopy, vol. 151, no. Pt 1, pp. 23–42, July 1988.

[6] M. L. Berlanga, S. Phan, E. A. Bushong, S. Wu, et al., “Three-
dimensional reconstruction of serial mouse brain sections: So-
lution for ﬂattening high-resolution large-scale mosaics,” Fron-
tiers in Neuroanatomy, vol. 5, Mar. 2011.

[7] K. M. Boergens and W. Denk, “Controlling FIB-SBEM slice
thickness by monitoring the transmitted ion beam,” Journal of
Microscopy, vol. 252, no. 3, pp. 258–262, Dec. 2013.

[8] Jon Sporring, Mahdieh Khanmohammadi, Sune Darkner, Nico-
letta Nava, et al., “Estimating the thickness of ultra thin sections
for electron microscopy by image statistics,” in 2014 IEEE 11th
International Symposium on Biomedical Imaging (ISBI), Apr.
2014, pp. 157–160.

511

POST-ACQUISITION IMAGE BASED COMPENSATION FOR THICKNESS VARIATION IN
MICROSCOPY SECTION SERIES

Philipp Hanslovsky, John A. Bogovic, Stephan Saalfeld

HHMI Janelia Research Campus
19700 Helix Drive, Ashburn, VA 20147

5
1
0
2
 
y
a
M
 
7
2
 
 
]

V
C
.
s
c
[
 
 
2
v
0
7
9
6
.
1
1
4
1
:
v
i
X
r
a

ABSTRACT

Serial section Microscopy is an established method for volu-
metric anatomy reconstruction. Section series imaged with
Electron Microscopy are currently vital for the reconstruc-
tion of the synaptic connectivity of entire animal brains such
as that of Drosophila melanogaster. The process of remov-
ing ultrathin layers from a solid block containing the speci-
men, however, is a fragile procedure and has limited preci-
sion with respect to section thickness. We have developed
a method to estimate the relative z-position of each individ-
ual section as a function of signal change across the section
series. First experiments show promising results on both se-
rial section Transmission Electron Microscopy (ssTEM) data
and Focused Ion Beam Scanning Electron Microscopy (FIB-
SEM) series. We made our solution available as Open Source
plugins for the TrakEM2 software and the ImageJ distribution
Fiji.

Index Terms— Serial Section Microscopy, Section

Thickness, Optimization, Fiji

1. INTRODUCTION

Serial section microscopy has been used to study the anatomy
of biological specimens for over 130 years [1]. Today, neu-
roscientists use serial section microscopy to reconstruct the
microcircuitry of animal nervous systems in their entirety.
Electron microscopy (EM) offers the necessary resolution to
resolve individual neuronal processes and synapses [2]. How-
ever, both serial section transmission electron microscopy
(ssTEM), and block-face scanning electron microscopy (BF-
SEM) generate section series with signiﬁcant thickness vari-
ance. In a situation where the size of relevant structures is
close to the resolution-limit imposed by section thickness,
such variance can render accurate reconstruction impossible.
?? top row shows an example of this thickness variance in
a virtual xz-cross-section through a section series acquired
with a focused ion beam milling scanning electron micro-
scope (FIB-SEM).

In order to rectify these distortions, we have developed an
image based method that estimates the position of each in-
dividual section along the z-axis of the volume. Using this

Fig. 1: FIB-SEM series before (top) and after (bottom) sec-
(a) shows an xz-slice through
tion thickness correction.
the volume, (b) shows the corresponding pairwise similar-
ity matrix (PSM) with intensity-encoded normalized cross-
correlation (NCC) values in the same z-coordinate frame. Ar-
rows mark a section range that appears highly compressed in
the original acquisition and biologically plausible after cor-
rection.

information, a corrected volume can be rendered, greatly fa-
cilitating manual and automatic reconstruction efforts.

The underlying observation of our method is that the bio-
logical tissue is a signal whose changing speed varies slowly
across the section series. Sections that are closer to each other
generally look more similar than those farther apart. In addi-
tion, individual sections vary in image quality and may con-
tain preparation artifacts which contributes uncorrelated noise
to the pairwise similarity estimate. We therefore simultane-
ously estimate the decay of simple pairwise similarity mea-
sures as a function of the distance between two sections, the
quality of each individual section, and the optimal position
of each section within the series such that the updated pair-
wise similarity measure is smooth. The result is a unique
z-position for each section, compensating for differences in
thickness (see ?? bottom row). This estimate can be exe-
cuted locally, accounting for varying section thickness across
the section plane. We make our method available as plug-
ins for the TrakEM2 software [3], and the ImageJ distribution
Fiji [4], and have published the source code on GitHub1.

1https://github.com/saalfeldlab/em-thickness-estimation

Published in IEEE International Symposium on Biomedical Imaging, 2015, pages 507–511.

© 2015 IEEE

2. RELATED WORK

The problem of varying thickness in microscopy section se-
ries has been observed and addressed in previous work. De
Groot [5] reviews four different methods to estimate section
thickness: (i) measuring tissue folds that are twice as thick
as the section, (ii) comparing electron scattering in the sec-
tion with a standard test curve, (iii) estimating section thick-
ness from interference patterns that occur when splitting a
light beam and placing the transparent refractile Epon-section
in one of the otherwise identical beam paths, and (iv) re-
embedding the sections, re-sectioning them perpendicularly
to the xy-plane, and then measuring the section thickness
within these sections from subsequent EM. Method (i) de-
pends on an artifact that compromises image quality, options
(ii,iii) require specialized instruments, and option (iv) is not
only laborious but requires that sections can be re-embedded
and re-imaged which is not possible in destructive imaging
modalities such as BF-SEM.

Berlanga et al. [6] manually annotate the top and bottom
surface areas of small image stacks and describe these sur-
faces by polynomial functions. They then transform the im-
age density (RGB-channel values) such that both surface ar-
eas are ﬂat and perpendicular to z. This method requires that
individual sections are acquired as volumes correctly repro-
It is not possible to com-
ducing their physical thickness.
pensate for thickness variation that is the result of physical
compression that differs between adjacent sections.

Boergens and Denk [7] developed an augmentation of the
FIB-SEM to correct for section thickness variation during im-
age acquisition. Later, they ascertain structural isotropy of
the sample and transform z-coordinates such that the peak
of the curve of autocorrelations of several xz-cross-sections
of the data has the same half width in both dimensions. Fi-
nally, the z-coordinate of each section is determined by the
average over all xz-cross-sections. This method enables au-
tomatic estimation of a scaling factor for sufﬁciently large
section ranges that guarantees isotropy of the contained data
assuming that local section thickness is constant.

Sporring et al. [8] operate on image data directly. Sim-
ilar to our method, the position of sections is estimated by
comparing a reference similarity decay curve with pairwise
In contrast with our
similarity estimates between sections.
method, the reference curve is generated from in-section pixel
intensities assuming strictly isotropic specimen. The context
with which a decision is made is limited, since only the pre-

vious section in the series is taken into account for z-position
updates. Noise in individual sections is not considered.

Our method is unique among previous approaches in that
it calculates an accurate globally consistent z-position for
each individual section directly from noisy post-acquisition
image data without further demands on instrument design or
imaging modality.
It has the potential to calculate section
thickness varying in x and y in a straight forward manner and
does not require manual annotations or processing of section
images. As a result, our method readily scales to large EM
data sets being routinely collected.

3. SECTION POSITION ESTIMATION

We start with the assumption that the spatial frequencies of
tissue change slowly across the series of sections. As a re-
sult, the similarities between tissue sections shifted in space
should decay with the magnitude of the shift. Since these tis-
sue properties give rise to the image contrast in microscopy,
we expect similarities between images of the tissue to reﬂect
those properties. Our method corrects section spacing by es-
timating z-shifts that match a locally smooth tissue similarity
decay curve. In our experiments, we have used normalized
cross correlation (NCC) as a measure for similarity. In ad-
dition, we are experimenting with other metrics that are less
sensitive to correct section alignment such as the inverse false
positive rate of invariant feature matches or the average corre-
lation coefﬁcient of local blockmatches. However, regardless
of which similarity metric is employed, the inherent similar-
ity decay curve is generally unknown. It therefore needs to
be estimated from the data while simultaneously correcting
z-coordinates. Furthermore, each section is compromised by
preparation artifacts (varying imaging conditions, differences
in staining, etc.). Assuming that these quality differences ap-
ply to each section individually, the “quality” of a section af-
fects all pairwise comparisons equally.

In ??, we combine these assumptions into an optimization

problem that jointly solves for

1. a “tissue inherent” similarity decay curve,

2. a quality measure for each section, and

3. z-shifts for each section such that observed similarity
curves are best explained by the tissue inherent curve

arg min
ρ,m,s

(cid:32)

(cid:88)

(cid:88)

zref

z

wf (z, zref)

(cid:88)

(cid:16)

ρ(i−z)
zref −

m(zref)m(z)

(c(z), i

R

−

(cid:17)2

z)

(cid:16)

+

m(zref)m(z)

(zref, z

zref)

−

−

ρzref (c(z)

−

(cid:17)2

c(zref))

i

R

+ws(z, zref)

(cid:110)

s(z)

(cid:16)

(cid:16)

ρ−1
zref

−

m(zref)m(z)

(zref, z

zref)

−

R

(cid:17)

(cid:16)

c(z)

−

−

c(zref)(cid:17)(cid:17)(cid:111)2 (cid:33)

.

(1)

508

y
t
i
r
a
l
i

m
S

i

y
t
i
r
a
l
i

m
S

i

4. EXPERIMENTS

We applied our method to two different data sets: (i) FIB-
SEM,2 dimensions 2048×128×1000 px, voxel-size 8×8×2 nm,
and (ii) ssTEM,3 dimensions 2580×3244×63 px, voxel-size
4×4×40 nm. The voxel depth of 2 nm and 40 nm, respec-
tively, is the reported nominal section thickness. As we will
see later, the actual thickness of individual sections varies
greatly.

Distance to reference section

Distance to reference section

(a) Similarity curve estimate

(b) Quality and shifts

4.1. Data Set 1: FIB-SEM

∈

Fig. 2: Iterative optimization: (a) For each section we sam-
Z to the
ple pairwise similarities at integral distances ∆z
reference in transformed space and weight sample contribu-
tion by a windowing function wf centered at the reference
section. ρ(
) is estimated by weighted averaging. We as-
|
sume symmetry, i.e. ρ(
∆z) = ρ(∆z). Function values at
real valued coordinates are generated by linear interpolation.
(b) All pairwise similarity estimates
at updated section po-
sitions are compared with ρ generating a vote for both quality
and position update.

∆z

R

−

|

The section thickness variation in the FIB-SEM image data is
apparent from the xz-cross-section shown in ??. Tissue ap-
pearance changes abruptly from fast to slow at the indicated
section. This indicates a sequence of thicker and thinner sec-
tions, respectively. Our method greatly reduces the severity of
this artifact, as evidenced by the “squeezed” and “stretched”
cross-sections through neuronal processes in the original im-
age that appear round as expected after correction. We es-
timated a min and max section spacing of 0.14 and 10.2 px
(0.28 nm and 20.4 nm) respectively.

z

−

In our notation, z, zref and i are indices for sections, ρ(i)
is the
value of the ﬁt of the similarity localized at z and evaluated at
i
z. wf and ws denote window functions that account for
local smoothness, m is a vector of quality measures for each
section, c holds the actual coordinates for each section, and
s holds the shifts with respect to the original (grid) positions.
(c(z), ∆z) is the measured value of the similarity
Finally,
for reference z at a distance ∆z.

R

This optimization problem has trivial solutions for all
m(z) = 0 and can arbitrarily stretch and compress the se-
ries, both potentially leading to further trivial solutions. We
therefore apply two bounding conditions:

1. ρ(z)

z = 1,

2. the minimum and maximum coordinates of the series
i.e. the series neither shifts nor

remain unchanged,
scales globally.

As there is no closed-form solution to this non-convex op-
timization problem, we approximate ?? by splitting it into
three separate terms that we solve iteratively in alternating
sequence until convergence is reached. Furthermore, an iter-
ative approach gives us maximum ﬂexibility to test a variety
of further regularizing constraints. First, we estimate the sim-
ilarity curve inherent to the tissue from the data (??). Second,
we estimate the quality of each section (??) and, third, we
calculate and apply the shift for each section (??). We repeat
these steps until a speciﬁed number of iterations is reached.

4.2. Data Set 2: ssTEM

In the ssTEM data set, the variances in section thickness are
not as dramatic as in the FIB-SEM data. Therefore, we cor-
rected thickness in the original data set and used the result
as the basis for two revealing simulated data sets: (i) we re-
moved sections from the original series to artiﬁcially create
gaps within the series, and (ii) we randomly reordered sec-
tions in the series. All results are visualized in ??. We down-
sampled the data set by a factor of 10 both in x and y for
isotropic data.

As a numeric measure of quality, we calculate mean and
max absolute difference between estimated z-positions for the
original stack and each modiﬁed stack. Any sections that have
been removed during stack modiﬁcation are ignored for this
evaluation.

Original: The section thicknesses in the ssTEM data do not
vary as much as in the FIB-SEM example. We estimated a
min and max section spacing of 0.6 and 1.6 px (24 nm and
64 nm) respectively. As a result, the corrected ssTEM xz-
cross-sections do not appear dramatically different than the
originals as is the case for FIB-SEM.

Missing Sections: We removed sections 20, 21, 22, 46, 47.
As a result, this stack contains ﬁve fewer sections than the
original and structures are shifted compared to their origi-
nal position (cf. ??). Our method correctly estimates a large

2FIB-SEM of Drosophila melanogaster CNS, courtesy of Ken Hayworth,

Shan Xu, Harald Hess, HHMI Janelia

3ssTEM of Drosophila melanogaster CNS, courtesy of Rick Fetter, Zhi-

hao Zheng, Davi Bock, HHMI Janelia

509

Fig. 3: Results of the method applied to a TEM series and deliberate modiﬁcations. We show an xz-section before (original)
and after correction (corrected), and the corresponding PSM with intensity-encoded NCC values in the same z-coordinate
frame. Arrows mark the places where sections were removed. White horizintal lines demark corresponding z-positions across
all xz-slices and PSMs for visual comparison. The estimated sections positions are almost identical in all three examples.

distance between those sections adjacent to those that were
removed. Due to the applied ﬂoor interpolation in ??, they
are rendered as thick sections (see arrows). The estimated
z-positions of sections deviate from the corresponding z-
positions in the original reference series by 0.13 px (5.2 nm)
on average, and 0.28 px (11.2 nm) at most.

±

Random Order: We randomly reposition each section
4 and then apply our algorithm, al-
within in a range of
lowing for the order of the sections to be changed whenever
indicated by the respective z-coordinates. Our method cor-
rectly recovers the initial order of the sections (??). The es-
timated z-positions of sections deviate from the correspond-
ing z-positions in the original reference series by 0.044 px
(1.76 nm) on average, and 0.13 px (5.2 nm) at most.

4.3. Runtimes

We executed our experiments on a Dell Precision T7610
workstation and measured runtimes for our procedure. Simi-
larity matrix estimation took 62.3 s and inference took 49.4 s
for the FIB-SEM experiment with 1000 sections and 150 it-
erations. These steps took 0.6 s and 0.4 s respectively, for the
TEM-experiments with 63 sections and 100 iterations.

5. DISCUSSION & FUTURE WORK

We developed an efﬁcient image based method to estimate ac-
curate z-positions of all images in microscopy image stacks
with unknown varying z-spacing. Our method can be used
to estimate section thickness in complete section series. In
addition, it can detect missing sections, however, it requires
further inspection to distinguish gaps due to section loss from

thick sections as the method reports only the position of in-
dividual sections. Finally, we demonstrated, that the method
recovers the original section order in moderately randomized
series which is particularly interesting for ssTEM where cor-
rect section order cannot be guaranteed.

In our experiments, we estimated a single z-position for
each section, however, we are planning to extend the method
to estimate thickness variation within sections, employing a
hierarchical coarse-to-ﬁne approach.

In this paper, we tested our method on series of up to
1000 sections with substantial variance in section spacing and
demonstrated its efﬁcacy. Depending solely on one-time es-
timation of pairwise similarity between sections which can
be achieved by sampling and in parallel, our method is not
limited by the size of individual section images. In practice,
we observed that sections that are 1000 or more pixels apart
have very little impact on each other. Therefore, larger se-
ries can be split into independent overlapping batches that are
processed in parallel and merged later. We believe that the
correction of section position will improve the performance
of both manual and automated segmentation methods by pro-
viding more consistent data across sections in z, and will test
this hypothesis in future work.

Our method is Open Source, publicly available in the Im-

ageJ distribution Fiji [4], and integrated in TrakEM2 [3].

6. ACKNOWLEDGEMENTS

This work was supported by HHMI. We thank Davi Bock,
Ken Hayworth, Harald Hess, Rick Fetter, Shan Xu, and Zhi-
hao Zheng for data collection and valuable discussion.

510

References

[1] G. J. Born,

“Die Plattenmodellirmethode,”

Archiv f¨ur

Mikroskopische Anatomie, vol. 22, no. 1, pp. 584–599, 1883.

[2] K. L. Briggman and D. D. Bock, “Volume electron microscopy
for neuronal circuit reconstruction,” Current Opinion in Neuro-
biology, vol. 22, no. 1, pp. 154–161, Feb. 2012.

[3] A. Cardona, S. Saalfeld, J. Schindelin, I. Arganda-Carreras,
et al., “TrakEM2 software for neural circuit reconstruction,”
PLoS ONE, vol. 7, no. 6, pp. e38011, June 2012.

[4] J. Schindelin, I. Arganda-Carreras, E. Frise, V. Kaynig, et al.,
“Fiji: an open-source platform for biological-image analysis,”
Nature Methods, vol. 9, no. 7, pp. 676–682, July 2012.

[5] D. M. De Groot, “Comparison of methods for the estimation
of the thickness of ultrathin tissue sections,” Journal of Mi-
croscopy, vol. 151, no. Pt 1, pp. 23–42, July 1988.

[6] M. L. Berlanga, S. Phan, E. A. Bushong, S. Wu, et al., “Three-
dimensional reconstruction of serial mouse brain sections: So-
lution for ﬂattening high-resolution large-scale mosaics,” Fron-
tiers in Neuroanatomy, vol. 5, Mar. 2011.

[7] K. M. Boergens and W. Denk, “Controlling FIB-SBEM slice
thickness by monitoring the transmitted ion beam,” Journal of
Microscopy, vol. 252, no. 3, pp. 258–262, Dec. 2013.

[8] Jon Sporring, Mahdieh Khanmohammadi, Sune Darkner, Nico-
letta Nava, et al., “Estimating the thickness of ultra thin sections
for electron microscopy by image statistics,” in 2014 IEEE 11th
International Symposium on Biomedical Imaging (ISBI), Apr.
2014, pp. 157–160.

511

