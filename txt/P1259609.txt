Cross-domain Object Detection through Coarse-to-Fine Feature Adaptation

Yangtao Zheng1, 2, 3 Di Huang1, 2, 3∗ Songtao Liu1, 2, 3 Yunhong Wang1, 3
1Beijing Advanced Innovation Center for Big Data and Brain Computing, Beihang University
2State Key Laboratory of Software Development Environment, Beihang University
3School of Computer Science and Engineering, Beihang University, Beijing 100191, China
{ytzheng,dhuang,liusongtao,yhwang}@buaa.edu.cn

0
2
0
2
 
r
a

M
 
3
2
 
 
]

V
C
.
s
c
[
 
 
1
v
5
7
2
0
1
.
3
0
0
2
:
v
i
X
r
a

Abstract

Recent years have witnessed great progress in deep
learning based object detection. However, due to the do-
main shift problem, applying off-the-shelf detectors to an
unseen domain leads to signiﬁcant performance drop. To
address such an issue, this paper proposes a novel coarse-
to-ﬁne feature adaptation approach to cross-domain ob-
ject detection. At the coarse-grained stage, different from
the rough image-level or instance-level feature alignment
used in the literature, foreground regions are extracted by
adopting the attention mechanism, and aligned according
to their marginal distributions via multi-layer adversarial
learning in the common feature space. At the ﬁne-grained
stage, we conduct conditional distribution alignment of
foregrounds by minimizing the distance of global prototypes
with the same category but from different domains. Thanks
to this coarse-to-ﬁne feature adaptation, domain knowledge
in foreground regions can be effectively transferred. Exten-
sive experiments are carried out in various cross-domain
detection scenarios. The results are state-of-the-art, which
demonstrate the broad applicability and effectiveness of the
proposed approach.

1. Introduction

In the past few years, Convolutional Neural Networks
(CNN) based methods have signiﬁcantly improved the ac-
curacies of plenty of computer vision tasks [21, 38, 49].
These remarkable gains often rely on large-scale bench-
marks, such as ImageNet [11] and MS COCO [35]. Due to
a phenomenon known as domain shift or dataset bias [59],
current CNN models suffer from performance degradation
when they are directly applied to novel scenes. In practice,
we are able to alleviate such an impact by building a task-
speciﬁc dataset that covers sufﬁciently diverse samples. Un-
fortunately, it is rather expensive and time-consuming to an-

∗corresponding author

Figure 1. Illustration of the proposed coarse-to-ﬁne feature adapta-
tion approach. It consists of two components, i.e., Attention-based
Region Transfer (ART) and Prototype-based Semantic Alignment
(PSA). The ART module ﬁgures out foregrounds from entire im-
ages in different domains and then aligns the marginal distribu-
tions on them. Further, the PSA module builds the prototype for
each category to achieve semantic alignment.
(Best viewed in
color.)

notate a large number of high-quality ground truths.

To address this dilemma, one promising way is to in-
troduce Unsupervised Domain Adaptation (UDA) to trans-
fer essential knowledge from an off-the-shelf labeled do-
main (referred to as the source domain) to a related un-
seen but unlabeled one (the target domain) [44]. Recently,
UDA methods have been greatly advanced by deep learning
techniques, and they mostly focus on generating domain-
invariant deep representation by reducing cross-domain dis-
crepancy (e.g. Maximum Mean Discrepancy [20] or H-
divergence [1]), which have proved very competent at im-
age classiﬁcation [40, 15, 51, 12, 27] and semantic segmen-
tation [23, 42, 64, 6]. Compared to them, object detection
is more complex, which is required to locate and classify all
instances of different objects within images; therefore, how
to effectively adapt a detector is indeed a challenging issue.
In the literature, there are many solutions tackling this
problem, including Semi-Supervised Learning (SSL) based
[4], pixel-level adaptation based [31, 25, 50], and feature-

level adaptation based [8, 22, 68, 52, 74]. The SSL based
method reduces the domain gap through consistency regu-
larization in a teacher-student scheme. However, the teacher
does not always convey more meaningful knowledge than
the student [28], and the detector thus tends to accumu-
late errors, leading to deteriorated detection performance.
Pixel-level based methods ﬁrst conduct style transfer [73]
to synthesize a target-like intermediate domain, aiming to
limit visual shift, and then train detectors in a supervised
manner. Nevertheless, it still remains a difﬁculty to guar-
antee the quality of generated images, especially in some
extreme cases, which may hurt the adapted results. Alterna-
tively, feature-level adaptation based methods mitigate the
domain shift by aligning the features across domains. Such
methods work more conveniently with competitive scores,
making them dominate the existing community.

In this category, domain adaptive Faster R-CNN [8] is
It incorporates both image-level and instance-
a pioneer.
level feature adaptation into the detection model. In [52],
Strong-Weak feature adaptation is launched on image-level.
This method mainly makes use of the focal loss to trans-
fer hard-to-classify examples, since the knowledge in them
is supposed to be more intrinsic for both domains. Al-
though they deliver promising performance, image-level or
instance-level feature adaptation is not so accurate as ob-
jects of interest locally distribute with diverse shapes. [74]
introduces K-means clustering to mine transferable regions
to optimize the adaptation quality. While attractive, this
method highly depends on the pre-deﬁned cluster number
and the size of the grouped regions, which is not ﬂexible,
particularly to real-world applications. Furthermore, in the
object detection task, there are generally multiple types of
objects, and each has its own sample distribution. But these
methods do not take such information into account and re-
gard the distributions of different objects as a whole for
adaptation, thereby leaving space for improvement.

In this paper, we present a coarse-to-ﬁne feature adap-
tation framework for cross-domain object detection. The
main idea is shown in Figure 1. Firstly, considering that
foregrounds between different domains share more com-
mon features compared to backgrounds [30], we propose
an Attention-based Region Transfer (ART) module to high-
light the importance of foregrounds, which works in a class-
agnostic coarse way. We extract foreground objects of inter-
est by leveraging the attention mechanism in high-level fea-
tures, and underline them during feature distribution align-
ment. Through multi-layer adversarial learning, effective
domain confusion can be performed with the complex de-
tection model. Secondly, category information of objects
tends to further reﬁne preceding feature adaptation, and
in this case it is necessary to distinguish different kinds
of foreground objects. Meanwhile, there is no guarantee
that foregrounds of source and target images in the same

batch have consistent categories, probably incurring object
mis-matches in some mini-batch, making semantic align-
ment in UDA rather tough. Consequently, we propose
a Prototype-based Semantic Alignment (PSA) module to
build the global prototype for each category across domains.
The prototypes are adaptively updated at each iteration, thus
suppressing the negative inﬂuence of false pseudo-labels
and class mis-matches.

In summary, the contributions are three-fold as follows:
• A new coarse-to-ﬁne adaptation approach is designed
for cross-domain two-stage object detection, which
progressively and accurately aligns deep features.
• Two adaptation modules, i.e., Attention-based Region
Transfer (ART) and Prototype-based Semantic Align-
ment (PSA), are proposed to learn domain knowledge
in foreground regions with category information.

• Extensive experiments are carried out in three major
benchmarks in terms of some typical scenarios, and
the results are state-of-the-art, demonstrating the ef-
fectiveness of the proposed approach.

2. Related Work

Object Detection. Object detection is a fundamental step
in computer vision and has received increasing attention
during decades. Most of traditional methods [63, 10, 13]
depend on handcrafted features and sophisticated pipelines.
In the era of deep learning, object detection can be mainly
split into the one-stage detectors [48, 37, 34, 36] and the
two-stage ones [18, 17, 49, 33]. However, those generic de-
tectors do not address the domain shift problem that hurts
detection performance in real-world scenes.
Domain Adaptation. Domain adaptation [2, 1] aims to
boost performance in the target domain by leveraging com-
mon knowledge from the source domain, which has been
widely studied in many visual tasks [67, 12, 72, 41, 7, 14].
With the advent of CNNs, many solutions reduce do-
main shift by learning domain-invariant features. Methods
along this line can be divided into two streams: criterion-
based [61, 39, 57] and adversarial learning-based [15, 60, 3,
46]. The former aligns the domain distributions by min-
imizing some statistical distances between deep features,
and the latter introduces the domain classiﬁer to construct
minimax optimization with the feature extractor. Despite
great success is achieved, the majority of them can only
handle relatively simple tasks, such as image classiﬁcation.
Cross-domain Object Detection. A number of tradi-
tional studies [66, 62, 43, 70] focus on adapting a speciﬁc
model (e.g., for pedestrian or vehicle detection) across do-
mains. Later, [47] proposes the adaptive R-CNN by sub-
space alignment [19]. More Recently, the methods can be
mainly grouped into four categories, including (1) Feature-
level based: [8] presents domain adaptive Faster R-CNN to

Figure 2. Overview of the proposed feature adaptation framework. We address the problem of domain shift on foreground regions by coarse-
to-ﬁne scheme with the ART and PSA modules. First, we utilize the attention map learned from the RPN module to localize foregrounds.
Combined with multiple domain classiﬁers, the ART module puts more emphasis on aligning feature distributions of foreground regions,
which achieves a coarse-grained adaptation in a category-agnostic way. Second, the PSA module makes use of ground truth labels (for
source) and pseudo labels (for target) to maintain global prototypes for each category, and delivers ﬁne-grained adaptation on foreground
regions in a category-ware mode.

alleviate image-level and instance-level shifts, and [22, 68]
extend this idea to multi-layer feature adaptation. [52] ex-
ploits strong-weak alignment components to attend strong
matching in local features and weak matching in global fea-
[74] mines discriminative regions that contain ob-
tures.
jects of interest and aligns their features across domains.
(2) SSL based: [4] integrates object relations into the mea-
sure of consistency cost with the mean teacher [58] model.
(3) Pixel-level based: [25, 50] employ CycleGAN to trans-
late the source domain to the target-like style.
[31] uses
domain diversiﬁcation and multi-domain invariant repre-
sentation learning to address the imperfect translation and
source-biased problem. (4) Others: [29] establishes a ro-
bust learning framework that formulates the cross-domain
detection problem as training with noisy labels. [30] intro-
duces weak self-training and adversarial background score
regularization for domain adaptive one-stage object detec-
tion.
[71] minimizes the wasserstein distance to improve
the stability of adaptation. [54] explores a gradient detach
based stacked complementary loss to adapt detectors.

As mentioned,

feature-level adaptation is the main
branch in cross-domain object detection, and its perfor-
mance is currently limited by inaccurate feature alignment.
The proposed method concentrates on two-stage detectors
and substantially improves the quality of feature alignment
by a coarse-to-ﬁne scheme, where the ART module learns
the adapted importance of foreground areas and the PSA
module encodes the distribution property of each class.

3. Method
3.1. Problem Formulation

i , cs

i , ys

i )}Ns

i = (bs

In the task of cross-domain object detection, we are
given a labeled source domain DS = {(xs
i=1, where
xs
i and ys
i ) denote the i-th image and its corre-
sponding labels, i.e., the coordinates of the bounding box b
and its associated category c respectively. In addition, we
i}Nt
have access to an unlabeled target domain DT = {xt
i=1.
We assume that the source and target samples are drawn
from different distributions (i.e., DS (cid:54)= DT ) but the cat-
egories are exactly the same. The goal is to improve the
detection performance in DT using the knowledge in DS.
3.2. Framework Overview

As shown in Figure 2, we introduce a feature adaptation
framework for cross-domain object detection, which con-
tains a detection network and two adaptation modules.

Detection Network. We select the reputed and powerful
Faster R-CNN [49] model as our base detector. Faster R-
CNN is a two-stage detector that consists of three major
components: 1) a backbone network G that extracts image
features, 2) a Region Proposal Network (RPN) that simul-
taneously predicts object bounds and objectness scores, and
3) a Region-of-Interest (RoI) head, including a bounding
box regressor B and a classiﬁer C for further reﬁnement.
The overall loss function of Faster R-CNN is deﬁned as:

Ldet(x) = Lrpn + Lreg + Lcls

(1)

where Lrpn, Lreg, and Lcls are the loss functions for the
RPN, RoI based regressor and classiﬁer, respectively.

Adaptation Modules. Different from most of the exist-
ing studies which typically reduce domain shift in the entire
feature space, we propose to conduct feature alignment on
foregrounds that are supposed to share more common prop-
erties across domains. Meanwhile, in contrast to current
methods that regard the samples of all objects as a whole,
we argue that the category information contributes to this
task and thus highlight the distribution of each category to
further reﬁne feature alignment. To this end, we design two
adaptation modules, i.e., Attention-based Region Transfer
(ART) and Prototype-based Semantic Alignment (PSA), to
fulﬁll a coarse-to-ﬁne knowledge transfer in foregrounds.

3.3. Attention-based Region Transfer

The ART module is designed to raise more attention to
align the distributions across two domains within the re-
gions of foregrounds. It is composed of two parts: the do-
main classiﬁers and the attention mechanism.

To align the feature distributions across domains, we in-
tegrate multiple domain classiﬁers D into the last three con-
volution blocks in the backbone network G, where a two-
player minimax game is constructed. Speciﬁcally, the do-
main classiﬁers D try to distinguish which domain the fea-
tures come from, while the backbone network G aims to
confuse the classiﬁers. In practice, G and D are connected
by the Gradient Reverse Layer (GRL) [15], which reverses
the gradients that ﬂow through G. When the training pro-
cess converges, G tends to extract domain-invariant feature
representation. Formally, the objective of adversarial learn-
ing in the l-th convolution block can be written as:

Ll

ADV = min
θGl

max
θDl

Exs∼DS log Dl(Gl(xs))

(2)

+ Ext∼DT log(1 − Dl(Gl(xt)))

where θGl and θDl are the parameters of Gl and Dl respec-
tively. Dl(·)(h,w) stands for the probability of the feature in
location (h, w) from the source domain.

Recall that the detection task is required to localize and
classify objects, and RoIs are usually more important than
backgrounds. However, the domain classiﬁers align all the
spatial locations of the whole image without focus, which
probably degrades adaptation performance. To deal with
this problem, we propose an attention mechanism to achieve
foreground-aware distribution alignment. As mentioned
in [49], the RPN in Faster R-CNN serves as the attention to
tell the detection model where to look, and we naturally uti-
lize the high-level feature in RPN to generate the attention
map, as shown in Figure 3. To be speciﬁc, given an image x
from an arbitrary domain, we denote Frpn(x) ∈ RH×W ×C
as the output feature map of the convolutional layer in the

Figure 3. Illustration of the attention mechanism. We ﬁrst extract
the feature map from the RPN module. Then, we construct a spa-
tial attention map by averaging values across the channel dimen-
sion. At last, ﬁltering is applied to suppress the noise.

RPN module, where H × W and C are the spatial dimen-
sions and the number of channels of the feature map, re-
spectively. Then, we construct a spatial attention map by
averaging activation values across the channel dimension.
Further, we ﬁlter out (set to zero) those values that are less
than the given threshold, which are more likely to belong to
the background regions. The attention map A(x) ∈ RH×W
is formulated as:

M (x) = S(

|F c

rpn(x)|)

T (x) =

M (x)(h,w)

1
C

(cid:88)

c

1
HW

(cid:88)

h,w

A(x) = I(M (x) > T (x)) ⊗ M (x)

(3)

(4)

(5)

where M (x) stands for the attention map before ﬁltering.
S(·) is the sigmoid function and I(·) is the indication func-
tion. F c
rpn(x) represents the c-th channel of the feature map.
⊗ denotes the element-wise multiplication. Threshold T (x)
is set to the mean value of M (x).

As the size of the attention map is not compatible with
the features in different convolution blocks, we adopt bi-
linear interpolation to perform up-sampling, thus produc-
ing the corresponding attention maps. Due to the fact that
the attention map may not always be so accurate, if a fore-
ground region is mistaken for background, its attention
weight is set to zero and cannot contribute to adaptation.
Inspired by the residual attention network in [65], we add a
skip connection to the attention map to enhance its perfor-
mance.

The total objective of the ART module is deﬁned as:

LART =

(1 + Ul(A(x)(h,w))) · Ll,h,w
ADV

(6)

(cid:88)

l,h,w

where Ul(·) is the up-sampling operation and Ll,h,w
ADV stands
for the adversarial loss on pixel (h, w) in the l-th convolu-
tion block. Combining adversarial learning with the atten-
tion mechanism, the ART module aligns the feature distri-
butions of foreground regions that are more transferable for
the detection task.

3.4. Prototype-based Semantic Alignment

Since the attention map from RPN carries no informa-
tion about classiﬁcation, the ART module aligns the fea-
ture distributions of foregrounds in a category-agnostic way.
To achieve class-aware semantic alignment, a straightfor-
ward method is to train domain classiﬁers for each cate-
gory. Nevertheless, there are two main disadvantages: (1)
training multiple class-speciﬁc classiﬁers is inefﬁcient; (2)
false pseudo-labels (e.g., backgrounds or misclassiﬁed fore-
grounds) occurred in the target domain may hurt the perfor-
mance of semantic alignment.

Inspired by the prototype-based methods in few-shot
learning [56] and cross-domain image classiﬁcation [69,
5, 45], we propose the PSA module to handle the above
problems. Instead of directly training classiﬁers, PSA tries
to minimize the distance between the pair of prototypes
(P S
k ) with the same category across domains, thus
maintaining the semantic consistency in the feature space.
Formally, the prototypes can be deﬁned as:

k , P T

P S

k =

P T

k =

1
|GTk|

1
|RoIk|

(cid:88)

F (r)

r∈GTk

(cid:88)

r∈RoIk

F (r)

(7)

(8)

k and P T

where P S
k represent the prototypes of the k-th cat-
egory in the source and target domain respectively. F (r)
denotes the feature of foreground region r after the second
fully-connected (FC) layer in the RoI head. We use the
ground truth GTk to extract the foreground regions in the
source domain. Due to the absence of target annotations,
we employ the RoIk provided by the RoI head module as
| · | indicates the
the pseudo labels in the target domain.
number of regions.

The beneﬁts of prototypes are two-fold: (1) the proto-
types have no extra trainable parameters and can be cal-
culated in linear time; (2) the negative inﬂuence of false
pseudo-labels can be suppressed by the correct ones whose
number is much larger when generating the prototypes. It
should be noted that the prototypes above are built over all
samples. In the training process, the size of each mini-batch
is usually small (e.g., 1 or 2) for the detection task, and the
foreground objects of source and target images in the same
batch may have inconsistent categories, making categori-
cal alignment not practical for all classes at this batch. For
example, two images (one for each domain) are randomly
selected for training, but Car only appears in the source im-
age. As a consequence, we cannot align the prototypes of
Car across domains in this batch.

To tackle the problem, we dynamically maintain global
prototypes, which are adaptively updated by local proto-
types at each mini-batch as follows:

α = sim(P (i)

k , GP (i−1)

k

)

(9)

Algorithm 1: The coarse-to-ﬁne feature adaptation
framework for cross-domain object detection.

Input: Labeled source domain DS.

Unlabeled target domain DT .
Batch size B. Category number C.

Output: An adaptive detector F (·; θ).

1 Calculate the initial global prototypes GP S(0)

and
using the pretrained detector based on DS

GP T (0)
k

k

2 for i = 1 to max iter do
3

XS, YS ← Sample(DS, B/2)
XT ← Sample(DT , B/2)
Supervised Learning:
Calculate Ldet according to Eq. (1)
Coarse-grained Adaptation:
Calculate A(XS) and A(XT ) by Eq. (5)
Calculate LART by Eq. (6)
Fine-grained Adaptation:
ˆYT ← F (XT ; θ)
for k = 1 to C do
Calculate P S(i)
Update GP S(i)

and P T (i)
k
and GP T (i)

k

k

Calculate LP SA according to Eq. (11)
Optimize the detection model by Eq. (12)

by Eq. (7) and (8)

by Eq. (10)

k

4

5

6

7

8

9

10

11

12

13

14

15

16

k

(10)

k + (1 − α)GP (i−1)
1 ·x2

k = αP (i)
GP (i)
where sim(x1, x2) = ( xT
(cid:107)x1(cid:107)(cid:107)x2(cid:107) + 1)/2 denotes the cosine
similarity. P (i)
represents the local prototypes of the k-th
k
category at i-th iteration. It is worth noting that we calculate
the initial global prototypes GP (0)
by Eq. (7) (for source)
and Eq. (8) (for target) based on the pretrained model from
the labeled source domain.

k

We do not directly align the local prototypes, but mini-
mize the L2 distance between the source global prototypes
GP S
k to achieve se-
mantic alignment. The objective of the PSA module at i-th
iteration can be formulated as following:

k and the target global prototypes GP T

LP SA =

(cid:107)GP S(i)

k − GP T (i)

k

(cid:107)2

(11)

(cid:88)

k

3.5. Network Optimization

The training procedure of our proposed framework inte-

grates three major components, as shown in Algorithm 1.

1. Supervised Learning. The supervised detection loss
Ldet is only applied to the labeled source domain DS.
2. Coarse-grained Adaptation. We utilize the attention
mechanism to extract the foregrounds in images. Then,
we focus on aligning the feature distributions of those
regions by optimizing LART .

Cityscapes → FoggyCityscapes

Method

Arch.

Bus

Bicycle

Car

Motor

Person

Rider

Train

Truck

mAP

mAP*

Gain

MTOR [4]
RLDA [29]

DAF [8]
SCDA [74]
MAF [22]
SWDA [52]
DD-MRL [31]
MDA [68]
PDA [25]

Source Only
3DC (Baseline)
Ours w/o ART
Ours w/o PSA
Ours

Oracle

R
I

V
V
V
V
V
V
V

V
V
V
V
V

V

38.6
45.3

35.3
39.0
39.9
36.2
38.4
41.8
44.1

25.0
37.9
41.6
45.2
43.2

49.5

35.6
36.0

27.1
33.6
33.9
35.3
32.2
36.5
35.9

26.8
37.1
35.4
37.3
37.4

37.0

44.0
49.2

40.5
48.5
43.9
43.5
44.3
44.8
54.4

30.6
51.6
51.5
51.8
52.1

28.3
26.9

20.0
28.0
29.2
30.0
28.4
30.5
29.1

15.5
33.1
36.9
33.3
34.7

52.7

36.0

30.6
35.1

25.0
33.5
28.2
29.9
30.8
33.2
36.0

24.1
32.9
33.5
33.9
34.0

36.1

41.4
42.2

31.0
38.0
39.5
42.3
40.5
44.2
45.5

29.4
45.6
45.2
46.7
46.9

47.1

40.6
27.0

20.2
23.3
33.3
32.6
34.5
28.7
25.8

4.6
27.9
26.6
25.5
29.9

56.0

21.9
30.0

22.1
26.5
23.8
24.5
27.2
28.2
24.3

10.6
28.6
28.2
29.6
30.8

32.1

35.1
36.5

27.6
33.8
34.0
34.3
34.6
36.0
36.9

20.8
36.8
37.4
37.9
38.6

43.3

26.9
31.9

18.8
26.2
18.8
20.3
17.9
22.8
19.6

-
20.8
20.8
20.8
20.8

-

8.2
4.6

8.8
7.6
15.2
14.0
16.7
13.2
17.3

-
16.0
16.6
17.1
17.8

-

Table 1. Results (%) of different methods in the Normal-to-Foggy adaptation scenario. “V”, “R” and “I” represent the VGG16, ResNet50
and Inception-v2 backbones respectively. “Source Only” denotes the Faster R-CNN model trained on the source domain only. “3DC”
stands for the Faster R-CNN model integrated with three domain classiﬁers, which is our baseline method. “Oracle” indicates the model
trained on the labeled target domain. mAP* shows the result of “Source Only” for each method, and Gain displays its the improvement
after adaptation. The best results are bolded and the second best results are underlined among the methods with the VGG16 backbone.

3. Fine-grained Adaptation. At ﬁrst, pseudo labels are
predicted in the target domain. We further update the
global prototypes for each category adaptively. Fi-
nally, semantic alignment on foreground objects is
achieved by optimizing LP SA.

With the terms aforementioned, the overall objective is:

Ltotal = Ldet + λ1LART + λ2LP SA,

(12)

where λ1 and λ2 denote the trade-off factors for the ART
module and the PSA module, respectively.

4. Experiments
4.1. Datasets and Scenarios

Datasets. Four datasets are used in evaluation.
(1)
Cityscapes [9] is a benchmark for semantic urban scene un-
derstanding. It contains 2,975 training images and 500 val-
idation images with pixel-level annotations. Since it is not
designed for the detection task, we follow [8] to use the
tightest rectangle of an instance segmentation mask as the
ground truth bounding box. (2) FoggyCityscapes [53] de-
rives from Cityscapes by adding synthetic fog to the orig-
inal images. Thus, the train/val split and annotations are
(3) SIM10k [26] is a
the same as those in Cityscapes.
synthetic dataset containing 10,000 images, which is ren-
dered from the video game Grand Theft Auto V (GTA5).
(4) KITTI [16] is another popular dataset for autonomous
driving. It consists of 7,481 labeled images for training.

Scenarios. Following [8], we evaluate the framework

under three adaptation scenarios as follows:

(1) Normal-to-Foggy (Cityscapes → FoggyCityscapes).
It aims to perform adaptation across different weather con-
ditions. During the training phase, we use the training set

of Cityscapes and FoggyCityscapes as the source and target
domain respectively. Results are reported in the validation
set of FoggyCityscapes.

(2) Synthetic-to-Real (SIM10k → Cityscapes). Syn-
thetic images offer an alternative to alleviate the data an-
notation problem. To adapt the synthetic scenes to the real
one, we utilize the entire SIM10k dataset as the source do-
main and the training set of Cityscapes as the target domain.
Since only Car is annotated in both domains, we report the
performance of Car in the validation set of Cityscapes.

(3) Cross-Camera (Cityscapes → KITTI). Images cap-
tured by different devices or setups also incur the domain
shift problem. To simulate this adaptation, we use the train-
ing set of Cityscapes as the source domain and the training
set of KITTI as the target domain. Note that the classiﬁca-
tion standards of categories in the two domains are different,
we follow [68] to classify {Car, Van} as Car, {Pedestrian,
Person sitting} as Person, Tram as Train, Cyclist as Rider in
KITTI. The results are reported in the training set of KITTI,
which is the same as in [8, 68].
4.2. Implementation Details

In all experiments, we adopt the Faster R-CNN with the
VGG16 [55] backbone pre-trained on ImageNet [11]. We
resize the shorter sides of all images to 600 pixels. The
batch size is set to 2, i.e., one image per domain. The detec-
tor is trained with SGD for 50k iterations with the learning
rate of 10−3, and it is then dropped to 10−4 for another 20k
iterations. Domain classiﬁers are trained by the Adam opti-
mizer [32] with the learning rate of 10−5. The factor λ1 is
set at 1.0. Since prototypes in the target domain are unre-
liable at the beginning, the PSA module is employed after
50k iterations with λ2 set at 0.01. We report mAP with an
IoU threshold of 0.5 for evaluation.

SIM10k → Cityscapes

Cityscapes → KITTI

Method

Arch.

AP on Car

AP*

Gain

Method

Arch. Person Rider Car Truck Train mAP mAP* Gain

RLDA [29]
MTOR [4]

DAF [8]
MAF [22]
SWDA [52]
MDA [68]
SCDA [74]

Source Only
3DC (Baseline)
Ours w/o ART
Ours w/o PSA
Ours

Oracle

I
R

V
V
V
V
V

V
V
V
V
V

V

42.6
46.6

39.0
41.1
42.3
42.8
43.0

35.0
42.3
42.7
43.4
43.8

59.9

31.1
39.4

30.1
30.1
34.6
34.3
34.0

-
35.0
35.0
35.0
35.0

-

11.5
7.2

8.9
11.0
7.7
8.5
9.0

-
7.3
7.7
8.4
8.8

-

Table 2. Results (%) of the Synthetic-to-Real adaptation scenario.

4.3. Results

We conduct extensive experiments and make comparison
to the state-of-the-art cross-domain object detection meth-
ods, including (1) Semi-Supervised Learning: MTOR [4],
(2) Robust Learning: RLDA [29], (3) Feature-level adap-
tation: DAF [8], SCDA [74], MAF [22], SWDA [52] and
MDA [68], and (4) Pixel-level adaptation + Feature-level
adaptation: DD-MRL [31] and PDA [25]. Moreover, we
also provide ablation studies to validate the effectiveness
of each module. Our baseline method is referred as 3DC,
which is the Faster R-CNN model integrated with three do-
main classiﬁers. We alternately remove the ART and PSA
module from the entire framework and report the perfor-
mance. Note that removing the ART means we only remove
the attention map while domain classiﬁers are still kept.
Normal-to-Foggy. As shown in Table 1, we achieve an
mAP of 38.6% on the weather transfer task, which is the
best result among all the counterparts. Since detection per-
formance before adaptation is different for each method,
we point out that “Gain” is also a key criterion for fair
comparison, which is ignored by previous work.
In par-
ticular, we achieve a remarkable increase of +17.8% over
the source only model. Among all the feature-level adapta-
tion methods, we improve the mAP by +2.6% compared to
MDA [68]. Although we do not leverage extra pixel-level
adaptation, our method still outperforms previous state-of-
the-art PDA [25] by +1.7%. Besides, with the help of
coarse-to-ﬁne feature adaptation on foregrounds, the pro-
posed method brings improvements on all the categories
than the 3DC model does, which shows that feature align-
ment on foregrounds can boost performance. Additionally,
we ﬁnd that the proposed method is comparable to or even
better than the oracle model in several categories. It sug-
gests that the performance which is similar to that of super-
vised learning methods can be achieved, if we effectively
transfer knowledge across domains.
Synthetic-to-Real. Table 2 displays the results on the
Synthetic-to-Real task. We obtain an average precision of

DAF [8]
MDA [68]

Source Only
3DC (Baseline)
Ours w/o ART
Ours w/o PSA
Ours

V
V

V
V
V
V
V

V

40.9
53.3

48.1
45.8
50.2
50.5
50.4

16.1 70.3
24.5 72.2

23.2 74.3
27.0 73.9
27.3 73.2
27.8 73.3
29.7 73.6

23.6
28.7

12.2
26.4
29.5
26.8
29.7

21.2
25.3

9.2
18.4
17.1
20.5
21.6

34.4
40.7

33.4
38.3
39.5
39.8
41.0

34.0
34.0

-
33.4
33.4
33.4
33.4

0.4
6.7

-
4.9
6.1
6.4
7.6

-

Oracle

71.1

86.6 88.4

90.7

90.1

85.4

-

Table 3. Results (%) of the Cross-Camera adaptation scenario.

43.8% on Car and ﬁnd that there is a slight gain of +0.8%
compared to SCDA [74]. The reason is that knowledge
transfer is much easier for single category, and many other
methods can also adapt well. Further, one may wonder why
the PSA module is still effective for single category adapta-
tion, and we argue that it serves as another attention mech-
anism that focuses on foreground regions, which conveys
some complementary clues to the ART module in this case.
Cross-Camera.
In Table 3, we illustrate the performance
comparison on the cross-camera task. The proposed method
reaches an mAP of 41.0% with a gain of +7.6% over the
non-adaptive model. Due to the fact that scenes are sim-
ilar across domains and the Car sample dominate the two
datasets, we can observe that the score on Car is already
good for the source only model. Compared with DAF [8]
and MDA [68], our method reduces the inﬂuence of nega-
tive transfer in Car detection. Meanwhile, our method also
outperforms the baseline model (3DC) in the rest categories.

4.4. Further Analysis
Feature distribution discrepancy of foregrounds. The
theoretical result in [2] suggests that A-distance can be used
as a metric of domain discrepancy. In practice, we calcu-
late the Proxy A-distance to approximate it, which is de-
ﬁned as dA = 2(1 − (cid:15)). (cid:15) is the generalization error of
a binary classiﬁer (linear SVM in our experiments) that
tries to distinguish which domain the input features come
from. Figure 5 displays the distances for each category
on the Normal-to-Foggy task with the features of ground
truth foregrounds extracted from the models of Source Only,
SWDA and Ours. Compared with the non-adaptive model,
SWDA and Ours reduce the distances in all the categories by
large margins, which demonstrates the necessity of domain
adaptation. Besides, since we explicitly optimize the proto-
types of each category by PSA, we achieve a smaller feature
distribution discrepancy of foregrounds than the others do.

Error analysis of highest conﬁdent detections. To fur-
ther validate the effect of the proposed framework for cross-
domain object detection, we analyze the errors of the mod-
els of Source Only, SWDA and Ours caused by highest
conﬁdent detections on the Normal-to-Foggy task. We fol-
low [24, 8, 4] to categorize the detections into three error

(a) Source Only

(b) SWDA

(c) Ours

(d) Attention Map

Figure 4. Qualitative results on the Normal-to-Foggy adaptation scenario. (a)-(c): The detection results of the Source Only model, SWDA
and the proposed method. (d): Visualization of the corresponding attention maps (best viewed by zooming in).

Figure 5. Feature distribution discrepancy of foregrounds.

types: 1) Correct (IoU with GT ≥ 0.5), 2) Mislocalization
(0.3 ≤ IoU with GT < 0.5), and 3) Background (IoU with
GT < 0.3). For each category, we select top-K predictions
to analyze the error type, where K is the number of ground
truths in this category. We report the mean percentage of
each type across all categories in Figure 6. We can see that
the Source Only model seems to take most of backgrounds
as false positives (green color). Compared with SWDA, we
improve the percentage of correct detections (blue color)
from 39.3% to 43.0% and reduce other error types simulta-
neously. The results indicate that the proposed framework
can effectively increase true positives and reduce false pos-
itives, resulting in better detection performance.
Qualitative results. Figure 4 shows some qualitative re-
sults. Due to the domain shift problem, the Source Only
model simply detects some salient objects as shown in (a).
From (b) to (c), we can observe that the proposed method
not only increases true positives (detects more cars in the
ﬁrst and second row), but also reduces false positives (dis-
cards persons in the third row), which is consistent with
previous analysis. Further, we visualize the attention maps
generated from the ART module. Despite some noise, the

Figure 6. Error analysis of highest conﬁdent detections.

attention maps well locate the foreground regions, which is
beneﬁcial to knowledge transfer across domains.

5. Conclusion

In this paper, we present a novel coarse-to-ﬁne feature
adaptation approach to address the issue of cross-domain
object detection. The proposed framework achieves the goal
with the incorporation of two delicately designed modules,
i.e., ART and PSA. The former highlights the importance of
the foreground regions ﬁgured out by the attention mecha-
nism in a category-agnostic way, and aligns their feature
distributions across domains. The latter takes the advantage
of prototypes to perform ﬁne-grained adaptation of fore-
grounds at the semantic level. Comprehensive experiments
are conducted on various adaptation scenarios and state-of-
the-art results are reached, demonstrating the effectiveness
of the proposed approach.

Acknowledgment. This work is funded by the National
Key Research and Development Plan of China under
Grant 2018AAA0102301, the Research Program of State
Key Laboratory of Software Development Environment
(SKLSDE-2019ZX-03), and the Fundamental Research
Funds for the Central Universities.

References

[1] S. Ben-David, J. Blitzer, K. Crammer, A. Kulesza, F. Pereira,
and J. W. Vaughan. A theory of learning from different do-
mains. Machine Learning, 79(1-2):151–175, 2010.

[2] S. Ben-David, J. Blitzer, K. Crammer, and F. Pereira. Anal-
ysis of representations for domain adaptation. In NeurIPS,
2007.

[3] K. Bousmalis, N. Silberman, D. Dohan, D. Erhan, and D. Kr-
ishnan. Unsupervised pixel-level domain adaptation with
generative adversarial networks. In CVPR, 2017.

[4] Q. Cai, Y. Pan, C.-W. Ngo, X. Tian, L. Duan, and T. Yao.
Exploring object relation in mean teacher for cross-domain
detection. In CVPR, 2019.

[5] C. Chen, W. Xie, W. Huang, Y. Rong, X. Ding, Y. Huang,
T. Xu, and J. Huang. Progressive feature alignment for un-
supervised domain adaptation. In CVPR, 2019.

[6] M. Chen, H. Xue, and D. Cai. Domain adaptation for se-
mantic segmentation with maximum squares loss. In ICCV,
2019.

[7] M.-H. Chen, Z. Kira, G. AlRegib, J. Yoo, R. Chen, and
J. Zheng. Temporal attentive alignment for large-scale video
domain adaptation. In ICCV, 2019.

[8] Y. Chen, W. Li, C. Sakaridis, D. Dai, and L. Van Gool. Do-
main adaptive faster r-cnn for object detection in the wild. In
CVPR, 2018.

[9] M. Cordts, M. Omran, S. Ramos, T. Rehfeld, M. Enzweiler,
R. Benenson, U. Franke, S. Roth, and B. Schiele. The
cityscapes dataset for semantic urban scene understanding.
In CVPR, 2016.

[10] N. Dalal and B. Triggs. Histograms of oriented gradients for

human detection. In CVPR, 2005.

[11] J. Deng, W. Dong, R. Socher, L.-J. Li, K. Li, and L. Fei-
Fei. Imagenet: A large-scale hierarchical image database. In
CVPR, 2009.

[12] Z. Ding, S. Li, M. Shao, and Y. Fu. Graph adaptive knowl-
edge transfer for unsupervised domain adaptation. In ECCV,
2018.

[13] P. Felzenszwalb, D. McAllester, and D. Ramanan. A dis-
criminatively trained, multiscale, deformable part model. In
CVPR, 2008.

[14] Y. Fu, Y. Wei, G. Wang, Y. Zhou, H. Shi, and T. S. Huang.
Self-similarity grouping: A simple unsupervised cross do-
main adaptation approach for person re-identiﬁcation.
In
ICCV, 2019.

[15] Y. Ganin and V. Lempitsky. Unsupervised domain adaptation

by backpropagation. In ICML, 2015.

[16] A. Geiger, P. Lenz, and R. Urtasun. Are we ready for au-
In

the kitti vision benchmark suite.

tonomous driving?
CVPR, 2012.

[17] R. Girshick. Fast r-cnn. In ICCV, 2015.
[18] R. Girshick, J. Donahue, T. Darrell, and J. Malik. Rich fea-
ture hierarchies for accurate object detection and semantic
segmentation. In CVPR, 2014.

[19] R. Gopalan, R. Li, and R. Chellappa. Domain adaptation
for object recognition: An unsupervised approach. In ICCV,
2011.

[20] A. Gretton, K. Borgwardt, M. J. Rasch, B. Scholkopf, and
A. J. Smola. A kernel method for the two-sample problem.
In NeurIPS, 2008.

[21] K. He, X. Zhang, S. Ren, and J. Sun. Deep residual learning

for image recognition. In CVPR, 2016.

[22] Z. He and L. Zhang. Multi-adversarial faster-rcnn for unre-

stricted object detection. In ICCV, 2019.

[23] J. Hoffman, E. Tzeng, T. Park, J.-Y. Zhu, P. Isola, K. Saenko,
A. A. Efros, and T. Darrell. Cycada: Cycle-consistent adver-
sarial domain adaptation. In ICML, 2018.

[24] D. Hoiem, Y. Chodpathumwan, and Q. Dai. Diagnosing error

in object detectors. In ECCV, 2012.

[25] H.-K. Hsu, W.-C. Hung, H.-Y. Tseng, C.-H. Yao, Y.-H. Tsai,
M. Singh, and M.-H. Yang. Progressive domain adaptation
for object detection. In CVPR Workshops, 2019.

[26] M. Johnson-Roberson, C. Barto, R. Mehta, S. N. Sridhar,
K. Rosaen, and R. Vasudevan. Driving in the matrix: Can
virtual worlds replace human-generated annotations for real
world tasks? In ICRA, 2017.

[27] G. Kang, L. Jiang, Y. Yang, and A. G. Hauptmann. Con-
trastive adaptation network for unsupervised domain adapta-
tion. In CVPR, 2019.

[28] Z. Ke, D. Wang, Q. Yan, J. Ren, and R. W. Lau. Dual stu-
dent: Breaking the limits of the teacher in semi-supervised
learning. In ICCV, 2019.

[29] M. Khodabandeh, A. Vahdat, M. Ranjbar, and W. G.
Macready. A robust learning approach to domain adaptive
object detection. In ICCV, 2019.

[30] S. Kim, J. Choi, T. Kim, and C. Kim. Self-training and ad-
versarial background regularization for unsupervised domain
adaptive one-stage object detection. In ICCV, 2019.

[31] T. Kim, M. Jeong, S. Kim, S. Choi, and C. Kim. Diver-
sify and match: A domain adaptive representation learning
paradigm for object detection. In CVPR, 2019.

[32] D. P. Kingma and J. Ba. Adam: A method for stochastic
optimization. arXiv preprint arXiv:1412.6980, 2014.
[33] T.-Y. Lin, P. Doll´ar, R. Girshick, K. He, B. Hariharan, and
S. Belongie. Feature pyramid networks for object detection.
In CVPR, 2017.

[34] T.-Y. Lin, P. Goyal, R. Girshick, K. He, and P. Doll´ar. Focal

loss for dense object detection. In ICCV, 2017.

[35] T.-Y. Lin, M. Maire, S. Belongie, J. Hays, P. Perona, D. Ra-
manan, P. Doll´ar, and C. L. Zitnick. Microsoft coco: Com-
mon objects in context. In ECCV, 2014.

[36] S. Liu, D. Huang, and Y. Wang. Receptive ﬁeld block net for

accurate and fast object detection. In ECCV, 2018.

[37] W. Liu, D. Anguelov, D. Erhan, C. Szegedy, S. Reed, C. Y.
Fu, and A. C. Berg. Ssd: Single shot multibox detector. In
ECCV, 2016.

[38] J. Long, E. Shelhamer, and T. Darrell. Fully convolutional
networks for semantic segmentation. In CVPR, 2015.
[39] M. Long, Y. Cao, J. Wang, and M. I. Jordan. Learning trans-
In ICML,

ferable features with deep adaptation networks.
2015.

[40] M. Long, J. Wang, G. Ding, J. Sun, and P. S. Yu. Transfer
feature learning with joint distribution adaptation. In ICCV,
2014.

[62] D. V´azquez, A. M. L´opez, and D. Ponsa. Unsupervised do-
main adaptation of virtual and real worlds for pedestrian de-
tection. In ICPR, 2012.

[63] P. Viola and M. Jones. Rapid object detection using a boosted

cascade of simple features. In CVPR, 2001.

[64] T.-H. Vu, H. Jain, M. Bucher, M. Cord, and P. Perez. Advent:
Adversarial entropy minimization for domain adaptation in
semantic segmentation. In CVPR, 2019.

[65] F. Wang, M. Jiang, C. Qian, S. Yang, C. Li, H. Zhang,
X. Wang, and X. Tang. Residual attention network for image
classiﬁcation. In CVPR, 2017.

[66] M. Wang and X. Wang. Automatic adaptation of a generic
pedestrian detector to a speciﬁc trafﬁc scene. In CVPR, 2011.
[67] Y. Xia, D. Huang, and Y. Wang. Detecting smiles of young
In ICCV Workshops,

children via deep transfer learning.
2017.

[68] R. Xie, F. Yu, J. Wang, Y. Wang, and L. Zhang. Multi-
level domain adaptive learning for cross-domain detection.
In ICCV Workshops, 2019.

[69] S. Xie, Z. Zheng, L. Chen, and C. Chen. Learning seman-
tic representations for unsupervised domain adaptation. In
ICML, 2018.

[70] J. Xu, S. Ramos, D. V´azquez, and A. M. L´opez. Do-
main adaptation of deformable part-based models. T-PAMI,
36(12):2367–2380, 2014.

[71] P. Xu, P. Gurram, G. Whipps, and R. Chellappa. Wasserstein
distance based domain adaptation for object detection. arXiv
preprint arXiv:1909.08675, 2019.

[72] S. Zhao, H. Fu, M. Gong, and D. Tao. Geometry-aware sym-
metric domain adaptation for monocular depth estimation. In
CVPR, 2019.

[73] J.-Y. Zhu, T. Park, P. Isola, and A. A. Efros. Unpaired image-
to-image translation using cycle-consistent adversarial net-
works. In ICCV, 2017.

[74] X. Zhu, J. Pang, C. Yang, J. Shi, and D. Lin. Adapting object
In CVPR,

detectors via selective cross-domain alignment.
2019.

[41] Y. Luo, P. Liu, T. Guan, J. Yu, and Y. Yang. Signiﬁcance-
aware information bottleneck for domain adaptive semantic
segmentation. In ICCV, 2019.

[42] Y. Luo, L. Zheng, T. Guan, J. Yu, and Y. Yang. Taking a
closer look at domain shift: Category-level adversaries for
semantics consistent domain adaptation. In CVPR, 2019.
[43] F. Mirrashed, V. I. Morariu, B. Siddiquie, R. S. Feris, and
L. S. Davis. Domain adaptive object detection. In WACV,
2013.

[44] S. J. Pan and Q. Yang. A survey on transfer learning. TKDE,

22(10):1345–1359, 2010.

[45] Y. Pan, T. Yao, Y. Li, Y. Wang, C.-W. Ngo, and T. Mei.
Transferrable prototypical networks for unsupervised do-
main adaptation. In CVPR, 2019.

[46] Z. Pei, Z. Cao, M. Long, and J. Wang. Multi-adversarial

domain adaptation. In AAAI, 2018.

[47] A. Raj, V. Namboodiri, and T. Tuytelaars. Subspace align-
ment based domain adaptation for rcnn detector. In BMVC,
2015.

[48] J. Redmon, S. Divvala, R. Girshick, and A. Farhadi. You
only look once: Uniﬁed, real-time object detection.
In
CVPR, 2016.

[49] S. Ren, K. He, R. Girshick, and J. Sun. Faster r-cnn: Towards
real-time object detection with region proposal networks. T-
PAMI, 39(6):1137–1149, 2017.

[50] A. L. Rodriguez and K. Mikolajczyk. Domain adaptation for
object detection via style consistency. In BMVC, 2019.
[51] K. Saito, Y. Ushiku, and T. Harada. Asymmetric tri-training
for unsupervised domain adaptation. In ICML, 2017.
[52] K. Saito, Y. Ushiku, T. Harada, and K. Saenko. Strong-
weak distribution alignment for adaptive object detection. In
CVPR, 2019.

[53] C. Sakaridis, D. Dai, and L. Van Gool. Semantic foggy scene
IJCV, 126(9):973–992,

understanding with synthetic data.
2018.

[54] Z. Shen, H. Maheshwari, W. Yao, and M. Savvides. Scl: To-
wards accurate domain adaptive object detection via gradient
detach based stacked complementary losses. arXiv preprint
arXiv:1911.02559, 2019.

[55] K. Simonyan and A. Zisserman. Very deep convolutional
networks for large-scale image recognition. arXiv preprint,
arXiv:1409.1556, 2014.

[56] J. Snell, K. Swersky, and R. Zemel. Prototypical networks

for few-shot learning. In NeurIPS, 2017.

[57] B. Sun and K. Saenko. Deep coral: Correlation alignment

for deep domain adaptation. In ECCV, 2016.

[58] A. Tarvainen and H. Valpola. Mean teachers are better role
models: Weight-averaged consistency targets improve semi-
supervised deep learning results. In NeurIPS, 2017.

[59] A. Torralba and A. A. Efros. Unbiased look at dataset bias.

In CVPR, 2011.

[60] E. Tzeng, J. Hoffman, K. Saenko, and T. Darrell. Adversarial

discriminative domain adaptation. In CVPR, 2017.

[61] E. Tzeng, J. Hoffman, N. Zhang, K. Saenko, and T. Darrell.
Deep domain confusion: Maximizing for domain invariance.
arXiv preprint arXiv:1412.3474, 2014.

